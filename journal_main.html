<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>GYEOL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- âœ… [ì¶”ê°€] ë„¤ì´ë²„ ì§€ë„ SDK â€” geocoder ì„œë¸Œëª¨ë“ˆ í¬í•¨ -->
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=i6tutiuf7r&submodules=geocoder"></script>

  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html { height:100%; min-height:100vh; }
    body { font-family:'Noto Sans KR',sans-serif; -webkit-font-smoothing:antialiased; height:100%; overscroll-behavior:none; }
    input, textarea, button, select { font-family:inherit; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    ::-webkit-scrollbar { display:none; }
    * { scrollbar-width:none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, createContext, useContext, useCallback } = React;

    const SUPABASE_URL = 'https://vgtpjvwtpzvxxlizsvos.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZndHBqdnd0cHp2eHhsaXpzdm9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODg1NjMsImV4cCI6MjA4NzA2NDU2M30.k1dm3cjQz0K8M4cc9vrxh11ET39u41SsxyWPWdTvOLs';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ë„¤ì´ë²„ ì§€ì—­ ê²€ìƒ‰ â€” /api/search-places (Vercel Serverless) ê²½ìœ 
    // í‚¤ëŠ” ì„œë²„ í™˜ê²½ë³€ìˆ˜ì—ë§Œ ìˆìœ¼ë¯€ë¡œ ë¸Œë¼ìš°ì €ì— ë…¸ì¶œë˜ì§€ ì•ŠìŒ
    async function naverSearchPlaces(query) {
      try {
        const res = await fetch(`https://my-first-web-eta.vercel.app/api/search-places?query=${encodeURIComponent(query)}`);
        if (!res.ok) { console.error("search-places API error:", res.status); return []; }
        const data = await res.json();
        console.log("search-places response:", data);
        return (data.items || []).map(item => ({
          name:    item.title.replace(/<[^>]+>/g, ""),
          address: item.roadAddress || item.address,
          lat:     parseFloat(item.mapy) / 10000000,
          lng:     parseFloat(item.mapx) / 10000000,
        }));
      } catch(e) { console.error("naverSearchPlaces error:", e); return []; }
    }

    // ========================================================
    // ğŸ¤– Gemini AI í—¬í¼ (Supabase Edge Function ê²½ìœ  - API í‚¤ ì„œë²„ì—ì„œ ê´€ë¦¬)
    // ========================================================
    async function callGemini(prompt) {
      try {
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/gemini-proxy`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({ prompt }),
          }
        );
        const data = await res.json();
        if (data.error) {
          console.error("Gemini API ì˜¤ë¥˜:", data.error);
          return `API ì˜¤ë¥˜: ${data.error}`;
        }
        return data.text || "ë¶„ì„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆì–´ìš”.";
      } catch (e) {
        console.error("Gemini í˜¸ì¶œ ì‹¤íŒ¨:", e);
        return "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¶„ì„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆì–´ìš”.";
      }
    }

    const T = {
      bg:"#F5F0E8", card:"#FFFCF7", accent:"#B8956A", accentLight:"#D4B896",
      accentBg:"#F0E6D6", text:"#4A3728", textSub:"#8B7355", border:"#E8DFD0",
      hover:"#EDE5D8", shadow:"0 2px 12px rgba(139,115,85,0.08)",
      shadowHover:"0 6px 24px rgba(139,115,85,0.14)",
      gradient:"linear-gradient(135deg,#B8956A,#9B7B5A)",
      input:"#F0EBE1", divider:"#E5DDD0", textMuted:"#A89F90",
      danger:"#C97064", success:"#8DB580",
    };

    // NVC ëŠë‚Œë§ ê¸°ë°˜ ê°ì • ì¹´í…Œê³ ë¦¬
    const EMOTION_CATEGORIES = [
      { label:"ìš•êµ¬ê°€ ì¶©ì¡±ë˜ì—ˆì„ ë•Œ", groups: [
        { group:"ê°ë™Â·ê°ì‚¬", color:"#C4A265", emotions: [
          {key:"moved",emoji:"ğŸ¥¹",label:"ê°ë™ë°›ì€"}, {key:"grateful",emoji:"ğŸ¥°",label:"ê°ì‚¬í•œ"}, {key:"fulfilled",emoji:"ğŸ˜‡",label:"ì¶©ë§Œí•œ"}, {key:"ecstatic",emoji:"ğŸ¤©",label:"í™©í™€í•œ"},
        ]},
        { group:"ê¸°ì¨Â·ì¦ê±°ì›€", color:"#E8A87C", emotions: [
          {key:"happy",emoji:"ğŸ˜Š",label:"í–‰ë³µí•œ"}, {key:"joyful",emoji:"ğŸ˜„",label:"ì¦ê±°ìš´"}, {key:"excited",emoji:"ğŸ‰",label:"ì‹ ë‚˜ëŠ”"}, {key:"fun",emoji:"ğŸ˜†",label:"ì¬ë¯¸ìˆëŠ”"},
        ]},
        { group:"ë”°ëœ»í•¨Â·ì¹œê·¼í•¨", color:"#D4897C", emotions: [
          {key:"warm",emoji:"ğŸ¤—",label:"ë”°ëœ»í•œ"}, {key:"loving",emoji:"ğŸ’•",label:"ì‚¬ë‘í•˜ëŠ”"}, {key:"cozy",emoji:"â˜ºï¸",label:"í¬ê·¼í•œ"}, {key:"tender",emoji:"ğŸ¥²",label:"ì• í‹‹í•œ"},
        ]},
        { group:"ë§Œì¡±Â·í¸ì•ˆí•¨", color:"#8DB580", emotions: [
          {key:"proud",emoji:"ğŸ’ª",label:"ë¿Œë“¯í•œ"}, {key:"satisfied",emoji:"ğŸ˜Œ",label:"ë§Œì¡±ìŠ¤ëŸ°"}, {key:"relieved",emoji:"ğŸ˜®â€ğŸ’¨",label:"í›„ë ¨í•œ"}, {key:"peaceful",emoji:"ğŸƒ",label:"í¸ì•ˆí•œ"}, {key:"calm",emoji:"ğŸ§˜",label:"ì°¨ë¶„í•œ"},
        ]},
        { group:"í™œê¸°Â·ìì‹ ê°", color:"#C49555", emotions: [
          {key:"energetic",emoji:"âš¡",label:"í™œê¸°ì°¬"}, {key:"confident",emoji:"ğŸ˜",label:"ìì‹ ê° ìˆëŠ”"}, {key:"hopeful",emoji:"âœ¨",label:"ê¸°ëŒ€ì— ë¶€í‘¼"}, {key:"brave",emoji:"ğŸ¦",label:"ìš©ê¸° ë‚˜ëŠ”"},
        ]},
      ]},
      { label:"ìš•êµ¬ê°€ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ì„ ë•Œ", groups: [
        { group:"ë‘ë ¤ì›€Â·ë¶ˆì•ˆ", color:"#A688B0", emotions: [
          {key:"anxious",emoji:"ğŸ˜°",label:"ë¶ˆì•ˆí•œ"}, {key:"worried",emoji:"ğŸ˜Ÿ",label:"ê±±ì •ë˜ëŠ”"}, {key:"scared",emoji:"ğŸ˜¨",label:"ë‘ë ¤ìš´"}, {key:"nervous",emoji:"ğŸ˜¬",label:"ê¸´ì¥í•œ"},
        ]},
        { group:"ë¶ˆí¸Â·ë‚œì²˜", color:"#B8956A", emotions: [
          {key:"uncomfortable",emoji:"ğŸ˜£",label:"ë¶ˆí¸í•œ"}, {key:"frustrated",emoji:"ğŸ˜¤",label:"ë‹µë‹µí•œ"}, {key:"confused",emoji:"ğŸ˜µâ€ğŸ’«",label:"í˜¼ë€ìŠ¤ëŸ¬ìš´"}, {key:"embarrassed",emoji:"ğŸ˜³",label:"ì°½í”¼í•œ"},
        ]},
        { group:"ìŠ¬í””Â·ì„œìš´í•¨", color:"#8BA4B8", emotions: [
          {key:"sad",emoji:"ğŸ˜¢",label:"ìŠ¬í”ˆ"}, {key:"missing",emoji:"ğŸ¥º",label:"ê·¸ë¦¬ìš´"}, {key:"disappointed",emoji:"ğŸ˜",label:"ì„œìš´í•œ"}, {key:"heartbroken",emoji:"ğŸ’”",label:"ì•ˆíƒ€ê¹Œìš´"},
        ]},
        { group:"ì™¸ë¡œì›€Â·ë¬´ë ¥ê°", color:"#9678A0", emotions: [
          {key:"lonely",emoji:"ğŸŒ™",label:"ì™¸ë¡œìš´"}, {key:"empty",emoji:"ğŸ•³ï¸",label:"ê³µí—ˆí•œ"}, {key:"depressed",emoji:"ğŸŒ§ï¸",label:"ìš°ìš¸í•œ"}, {key:"helpless",emoji:"ğŸ˜¶",label:"ë¬´ë ¥í•œ"},
        ]},
        { group:"í”¼ë¡œÂ·í™”", color:"#C97064", emotions: [
          {key:"tired",emoji:"ğŸ˜´",label:"í”¼ê³¤í•œ"}, {key:"bored",emoji:"ğŸ¥±",label:"ì§€ê²¨ìš´"}, {key:"angry",emoji:"ğŸ˜ ",label:"í™”ë‚˜ëŠ”"}, {key:"upset",emoji:"ğŸ¤¯",label:"ì†ìƒí•œ"},
        ]},
      ]},
    ];

    // í”Œë« ë§µ â€” ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš©
    const EMOTIONS = {};
    EMOTION_CATEGORIES.forEach(cat => cat.groups.forEach(g => g.emotions.forEach(e => {
      EMOTIONS[e.key] = { emoji: e.emoji, label: e.label, color: g.color };
    })));
    const EMO_KEYS = Object.keys(EMOTIONS);
    const ACTIVITIES = ["ğŸƒ ìš´ë™","ğŸ“š ë…ì„œ","ğŸµ ìŒì•…","ğŸ³ ìš”ë¦¬","ğŸ® ê²Œì„","â˜• ì¹´í˜","ğŸ¬ ì˜í™”","ğŸ’» ì½”ë”©","ğŸ§˜ ëª…ìƒ","ğŸ“¸ ì‚¬ì§„","ğŸ›’ ì‡¼í•‘","ğŸ‘¥ ëª¨ì„","ğŸš¶ ì‚°ì±…","ğŸ  ì§‘"];
    const INTENSITY = ["ì•½í•¨","ë³´í†µ","ê°•í•¨","ë§¤ìš° ê°•í•¨"];

    const today = () => new Date().toISOString().slice(0,10);
    const fmt = d => {
      const x = new Date(d+"T00:00:00");
      const w = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      return `${x.getMonth()+1}/${x.getDate()} (${w[x.getDay()]})`;
    };
    const fmtFull = d => {
      const x = new Date(d+"T00:00:00");
      const w = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      return `${x.getFullYear()}ë…„ ${x.getMonth()+1}ì›” ${x.getDate()}ì¼ ${w[x.getDay()]}ìš”ì¼`;
    };
    const isToday = d => d === today();

    const AuthCtx = createContext(null);
    const useAuth = () => useContext(AuthCtx);

    function AuthProvider({children}) {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        sb.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null); setLoading(false);
        });
        const { data: { subscription } } = sb.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null); setLoading(false);
        });
        return () => subscription.unsubscribe();
      }, []);
      const login = async (provider, email, pw) => {
        setLoading(true); let errMsg = null;
        if (provider === 'email') {
          const { error } = await sb.auth.signInWithPassword({ email, password: pw });
          if (error) errMsg = error.message === 'Invalid login credentials' ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' : error.message;
        } else {
          const redirectTo = window.location.origin + window.location.pathname;
          const { error } = await sb.auth.signInWithOAuth({ provider, options: { redirectTo } });
          if (error) errMsg = error.message;
        }
        setLoading(false); return errMsg;
      };
      const signup = async (email, pw, name) => {
        const { error } = await sb.auth.signUp({ email, password: pw, options: { data: { name } } });
        if (error) return error.message === 'User already registered' ? 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.' : error.message;
        return null;
      };
      const logout = async () => { await sb.auth.signOut(); };
      const displayName = user?.user_metadata?.name || user?.email?.split('@')[0] || 'ì‚¬ìš©ì';
      const displayEmail = user?.email || '';
      return (
        <AuthCtx.Provider value={{ user: user ? { ...user, name: displayName, email: displayEmail } : null, loading, login, signup, logout }}>
          {children}
        </AuthCtx.Provider>
      );
    }

    function LoadingScreen({text="ë‚˜ì˜ ê²°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."}) {
      return (
        <div style={{position:"fixed",inset:0,background:T.bg,display:"flex",alignItems:"center",justifyContent:"center"}}>
          <div style={{textAlign:"center"}}>
            <div style={{fontSize:52,marginBottom:16,animation:"pulse 1.5s infinite",letterSpacing:6,fontWeight:800,color:T.accent}}>GYEOL</div>
            <div style={{fontSize:13,color:T.textMuted||T.textSub,marginTop:4}}>{text}</div>
          </div>
        </div>
      );
    }

    function LoginPage() {
      const {login, signup, loading} = useAuth();
      const [mode, setMode] = useState("login");
      const [email, setEmail] = useState(""); const [pw, setPw] = useState("");
      const [name, setName] = useState(""); const [pwConfirm, setPwConfirm] = useState("");
      const [error, setError] = useState(""); const [agreeTerms, setAgreeTerms] = useState(false);
      const [agreePrivacy, setAgreePrivacy] = useState(false); const [submitting, setSubmitting] = useState(false);
      const [signupDone, setSignupDone] = useState(false);
      if (loading) return <LoadingScreen text="ë‚˜ì˜ ê²°ì„ ë°œê²¬í•˜ëŠ” ì¤‘..."/>;
      const inp = { width:"100%", padding:"14px 16px", borderRadius:12, border:`1.5px solid ${T.border}`, background:T.card, fontSize:16, color:T.text, outline:"none", boxSizing:"border-box", WebkitAppearance:"none" };
      const handleLogin = async () => { setError(""); if (!email.trim()) return setError("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); if (pw.length < 6) return setError("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); setSubmitting(true); const err = await login("email", email, pw); setSubmitting(false); if (err) setError(err); };
      const handleSocial = async (provider) => { setError(""); setSubmitting(true); const err = await login(provider); setSubmitting(false); if (err) setError(err); };
      const handleSignup = async () => { setError(""); if (!name.trim()) return setError("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); if (!email.includes("@")) return setError("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."); if (pw.length < 6) return setError("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); if (pw !== pwConfirm) return setError("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); if (!agreeTerms || !agreePrivacy) return setError("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”."); setSubmitting(true); const err = await signup(email, pw, name); setSubmitting(false); if (err) setError(err); else setSignupDone(true); };
      const handleForgot = async () => { if (!email.includes("@")) return setError("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); setSubmitting(true); const { error } = await sb.auth.resetPasswordForEmail(email); setSubmitting(false); if (error) setError(error.message); else { alert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."); setMode("login"); } };
      const Btn = ({onClick, style, children, disabled}) => (
        <button onClick={onClick} disabled={disabled||submitting} style={{...style, opacity:submitting?0.7:1, cursor:submitting?"not-allowed":"pointer"}}>{submitting ? "ì²˜ë¦¬ ì¤‘..." : children}</button>
      );
      return (
        <div style={{ minHeight:"100dvh", background:`linear-gradient(180deg,${T.bg} 0%,#EDE5D8 100%)`, display:"flex", alignItems:"center", justifyContent:"center", padding:"20px", paddingTop:`calc(env(safe-area-inset-top,0px) + 20px)`, paddingBottom:`calc(env(safe-area-inset-bottom,0px) + 20px)`, overflowY:"auto" }}>
          <div style={{ width:"100%", maxWidth:420, background:T.card, borderRadius:24, padding:"40px 28px", boxShadow:"0 8px 40px rgba(139,115,85,0.12)" }}>
            <div style={{textAlign:"center", marginBottom:32}}>
              <div style={{fontSize:32, fontWeight:800, color:T.accent, letterSpacing:6, marginBottom:8}}>GYEOL</div>
              <div style={{fontSize:14, color:T.textSub, marginTop:4, lineHeight:1.6}}>ë‹¹ì‹ ì€ ì–´ë–¤ ê²°ì„ ê°€ì§„ ì‚¬ëŒì¸ê°€ìš”?</div>
            </div>
            {signupDone && (<div style={{padding:"20px", textAlign:"center"}}><div style={{fontSize:40, marginBottom:12}}>âœ‰ï¸</div><div style={{fontSize:16, fontWeight:700, color:T.text, marginBottom:8}}>ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div><div style={{fontSize:14, color:T.textSub, lineHeight:1.7, marginBottom:20}}>ê°€ì…í•˜ì‹  ì´ë©”ì¼ë¡œ ì¸ì¦ ë§í¬ë¥¼ ë³´ëƒˆì–´ìš”.<br/>ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.</div><button onClick={()=>{setSignupDone(false);setMode("login");}} style={{background:"none", border:`1px solid ${T.border}`, borderRadius:10, padding:"10px 24px", color:T.textSub, fontSize:14, cursor:"pointer"}}>ë¡œê·¸ì¸ìœ¼ë¡œ</button></div>)}
            {!signupDone && mode==="login" && (<>
              <div style={{display:"flex", flexDirection:"column", gap:10, marginBottom:20}}>
                <button onClick={()=>handleSocial('google')} style={{padding:"14px 16px", borderRadius:12, border:`1.5px solid ${T.border}`, background:T.card, color:T.text, fontSize:15, fontWeight:700, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:8, minHeight:50}}><span style={{fontSize:16, fontWeight:900}}>G</span> Googleë¡œ ì‹œì‘í•˜ê¸°</button>
              </div>
              <div style={{display:"flex", alignItems:"center", gap:10, margin:"16px 0"}}><div style={{flex:1, height:1, background:T.border}}/><span style={{fontSize:12, color:T.textSub, whiteSpace:"nowrap"}}>ë˜ëŠ” ì´ë©”ì¼</span><div style={{flex:1, height:1, background:T.border}}/></div>
              <div style={{display:"flex", flexDirection:"column", gap:10}}>
                <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="ì´ë©”ì¼" type="email" style={inp} autoCapitalize="none" autoCorrect="off"/>
                <input value={pw} onChange={e=>setPw(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" style={inp} onKeyDown={e=>e.key==="Enter"&&handleLogin()}/>
              </div>
              {error && <div style={{marginTop:10, padding:"10px 14px", borderRadius:10, background:"#FFF0EE", color:T.danger, fontSize:13, fontWeight:500}}>{error}</div>}
              <Btn onClick={handleLogin} style={{width:"100%", padding:16, borderRadius:12, border:"none", background:T.gradient, color:"#fff", fontSize:16, fontWeight:700, marginTop:16, minHeight:52}}>ë‚˜ì˜ ê²° ì°¾ê¸° â†’</Btn>
              <div style={{display:"flex", justifyContent:"space-between", marginTop:14}}>
                <button onClick={()=>{setMode("forgot");setError("");}} style={{background:"none", border:"none", color:T.textSub, fontSize:13, cursor:"pointer", padding:"8px 0", minHeight:40}}>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
                <button onClick={()=>{setMode("signup");setError("");}} style={{background:"none", border:"none", color:T.accent, fontSize:13, fontWeight:700, cursor:"pointer", padding:"8px 0", minHeight:40}}>íšŒì›ê°€ì… â†’</button>
              </div>
            </>)}
            {!signupDone && mode==="signup" && (<>
              <div style={{fontSize:18, fontWeight:700, color:T.text, marginBottom:16}}>íšŒì›ê°€ì…</div>
              <div style={{display:"flex", flexDirection:"column", gap:10}}>
                <input value={name} onChange={e=>setName(e.target.value)} placeholder="ì´ë¦„" style={inp}/>
                <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="ì´ë©”ì¼" type="email" style={inp} autoCapitalize="none"/>
                <input value={pw} onChange={e=>setPw(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" type="password" style={inp}/>
                <input value={pwConfirm} onChange={e=>setPwConfirm(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" type="password" style={inp}/>
              </div>
              <div style={{marginTop:14, display:"flex", flexDirection:"column", gap:10}}>
                <label style={{display:"flex", alignItems:"center", gap:10, fontSize:14, color:T.text, cursor:"pointer", padding:"4px 0"}}><input type="checkbox" checked={agreeTerms} onChange={e=>setAgreeTerms(e.target.checked)} style={{width:18,height:18,accentColor:T.accent}}/><span style={{color:T.danger, fontWeight:700}}>[í•„ìˆ˜]</span> ì´ìš©ì•½ê´€ ë™ì˜</label>
                <label style={{display:"flex", alignItems:"center", gap:10, fontSize:14, color:T.text, cursor:"pointer", padding:"4px 0"}}><input type="checkbox" checked={agreePrivacy} onChange={e=>setAgreePrivacy(e.target.checked)} style={{width:18,height:18,accentColor:T.accent}}/><span style={{color:T.danger, fontWeight:700}}>[í•„ìˆ˜]</span> ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë™ì˜</label>
              </div>
              {error && <div style={{marginTop:10, padding:"10px 14px", borderRadius:10, background:"#FFF0EE", color:T.danger, fontSize:13}}>{error}</div>}
              <Btn onClick={handleSignup} style={{width:"100%", padding:16, borderRadius:12, border:"none", background:T.gradient, color:"#fff", fontSize:16, fontWeight:700, marginTop:16, minHeight:52}}>ê°€ì…í•˜ê¸°</Btn>
              <button onClick={()=>{setMode("login");setError("");}} style={{width:"100%", padding:12, background:"none", border:"none", color:T.textSub, fontSize:14, cursor:"pointer", marginTop:6, minHeight:44}}>â† ë¡œê·¸ì¸ìœ¼ë¡œ</button>
            </>)}
            {mode==="forgot" && (<>
              <div style={{fontSize:18, fontWeight:700, color:T.text, marginBottom:8}}>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</div>
              <div style={{fontSize:13, color:T.textSub, marginBottom:16, lineHeight:1.6}}>ê°€ì…í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì‹œë©´<br/>ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë ¤ìš”.</div>
              <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="ì´ë©”ì¼" type="email" style={inp} autoCapitalize="none"/>
              {error && <div style={{marginTop:10, padding:"10px 14px", borderRadius:10, background:"#FFF0EE", color:T.danger, fontSize:13}}>{error}</div>}
              <Btn onClick={handleForgot} style={{width:"100%", padding:16, borderRadius:12, border:"none", background:T.gradient, color:"#fff", fontSize:16, fontWeight:700, marginTop:14, minHeight:52}}>ì¬ì„¤ì • ë§í¬ ë³´ë‚´ê¸°</Btn>
              <button onClick={()=>{setMode("login");setError("");}} style={{width:"100%", padding:12, background:"none", border:"none", color:T.textSub, fontSize:14, cursor:"pointer", marginTop:6, minHeight:44}}>â† ë¡œê·¸ì¸ìœ¼ë¡œ</button>
            </>)}
          </div>
        </div>
      );
    }

    // ========================================================
    // âœ… NaverMapPicker â€” ê²€ìƒ‰ ê¸°ë°˜ ì¥ì†Œ ì„ íƒê¸°
    // ê²€ìƒ‰ â†’ í•€ìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ â†’ í•€/ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒ
    // onSelect(place) â†’ { name, address, lat, lng }
    // ========================================================
    function NaverMapPicker({ onSelect, onClose }) {
      const mapRef     = useRef(null);
      const mapInst    = useRef(null);
      const markersRef  = useRef([]);
      const searchRef   = useRef(null);
      const resultsRef  = useRef([]);

      const [query, setQuery]               = useState("");
      const [searching, setSearching]       = useState(false);
      const [results, setResults]           = useState([]);
      const [selectedPlace, setSelectedPlace] = useState(null);
      const [hasSearched, setHasSearched]   = useState(false);
      const [searchError, setSearchError]   = useState("");

      // resultsë¥¼ refì—ë„ ë™ê¸°í™” (ë§ˆì»¤ í´ë¦­ í´ë¡œì €ì—ì„œ ìµœì‹  ê°’ ì°¸ì¡°ìš©)
      useEffect(() => { resultsRef.current = results; }, [results]);

      // ì§€ë„ ì´ˆê¸°í™”
      useEffect(() => {
        if (!mapRef.current || mapInst.current) return;
        if (!window.naver?.maps) return;
        const map = new window.naver.maps.Map(mapRef.current, {
          center: new window.naver.maps.LatLng(37.5665, 126.978),
          zoom: 14,
        });
        mapInst.current = map;

        // ì§€ë„ í´ë¦­ â†’ ì—­ì§€ì˜¤ì½”ë”© (í´ë°±: ê²€ìƒ‰ ì•ˆ í•˜ê³  ì§ì ‘ ì§€ë„ í´ë¦­ë„ ê°€ëŠ¥)
        window.naver.maps.Event.addListener(map, "click", e => {
          const ll = e.coord;
          clearMarkers();
          addMarker(ll, null, true);
          window.naver.maps.Service.reverseGeocode(
            { coords: ll, orders: [window.naver.maps.Service.OrderType.ROAD_ADDR, window.naver.maps.Service.OrderType.ADDR] },
            (status, response) => {
              const r = response.v2?.results?.[0];
              if (!r) return;
              const reg = r.region; const land = r.land;
              const addr = `${reg.area1.name} ${reg.area2.name} ${reg.area3.name} ${land?.name||""} ${land?.number1||""}`.trim();
              setSelectedPlace({ name: addr, address: addr, lat: ll.lat(), lng: ll.lng() });
              setResults([]);
              setHasSearched(false);
            }
          );
        });
      }, []);

      // ë§ˆì»¤ ê´€ë¦¬
      const clearMarkers = () => {
        markersRef.current.forEach(m => m.setMap(null));
        markersRef.current = [];
      };

      const addMarker = (ll, place, isSelected) => {
        const marker = new window.naver.maps.Marker({
          position: ll,
          map: mapInst.current,
          animation: window.naver.maps.Animation.DROP,
          icon: isSelected ? undefined : {
            content: `<div style="width:28px;height:28px;background:${T.accent};border:3px solid #fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>`,
            anchor: new window.naver.maps.Point(14, 14),
          },
        });
        if (place) {
          window.naver.maps.Event.addListener(marker, "click", () => {
            setSelectedPlace(place);
            // ì„ íƒ ë§ˆì»¤ ê°•ì¡°: ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¼
            clearMarkers();
            resultsRef.current.forEach(p => {
              const pos = new window.naver.maps.LatLng(p.lat, p.lng);
              const isSel = p.lat === place.lat && p.lng === place.lng;
              addMarker(pos, p, isSel);
            });
          });
        }
        markersRef.current.push(marker);
        return marker;
      };

      // ê²€ìƒ‰ ì‹¤í–‰
      const doSearch = async () => {
        const q = query.trim();
        if (!q) return;
        setSearching(true);
        setSelectedPlace(null);
        setHasSearched(true);
        setSearchError("");
        try {
          const items = await naverSearchPlaces(q);
          setResults(items);
          clearMarkers();
          if (items.length > 0 && mapInst.current) {
            const bounds = new window.naver.maps.LatLngBounds();
            items.forEach(p => {
              const pos = new window.naver.maps.LatLng(p.lat, p.lng);
              bounds.extend(pos);
              addMarker(pos, p, false);
            });
            if (items.length === 1) {
              mapInst.current.setCenter(new window.naver.maps.LatLng(items[0].lat, items[0].lng));
              mapInst.current.setZoom(16);
            } else {
              mapInst.current.fitBounds(bounds, { top:80, bottom:200, left:40, right:40 });
            }
          } else if (items.length === 0) {
            setSearchError("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.");
          }
        } catch(e) {
          setResults([]);
          setSearchError("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì§€ë„ë¥¼ ì§ì ‘ ëˆŒëŸ¬ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
        setSearching(false);
      };

      // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¥ì†Œ ì„ íƒ
      const selectFromList = (place) => {
        setSelectedPlace(place);
        if (mapInst.current) {
          mapInst.current.setCenter(new window.naver.maps.LatLng(place.lat, place.lng));
          mapInst.current.setZoom(16);
          clearMarkers();
          results.forEach(p => {
            const pos = new window.naver.maps.LatLng(p.lat, p.lng);
            const isSel = p.lat === place.lat && p.lng === place.lng;
            addMarker(pos, p, isSel);
          });
        }
      };

      // Enter í‚¤ ê²€ìƒ‰
      const handleKeyDown = (e) => {
        if (e.key === "Enter") { e.preventDefault(); doSearch(); }
      };

      // ë§ˆìš´íŠ¸ ì‹œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤
      useEffect(() => { setTimeout(() => searchRef.current?.focus(), 300); }, []);

      return (
        <div style={{ position:"fixed", inset:0, zIndex:300, background:T.bg, display:"flex", flexDirection:"column", fontFamily:"'Noto Sans KR',sans-serif" }}>
          {/* í—¤ë” + ê²€ìƒ‰ */}
          <div style={{ background:T.card, borderBottom:`1px solid ${T.border}`, paddingTop:`calc(env(safe-area-inset-top,0px) + 12px)`, paddingBottom:12, flexShrink:0 }}>
            <div style={{ padding:"0 16px", display:"flex", alignItems:"center", gap:10, marginBottom:10 }}>
              <button onClick={onClose} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:T.textSub,minWidth:44,minHeight:44,display:"flex",alignItems:"center"}}>â†</button>
              <span style={{fontSize:17, fontWeight:700, color:T.text}}>ì¥ì†Œ ê²€ìƒ‰</span>
            </div>
            {/* ê²€ìƒ‰ë°” */}
            <div style={{ padding:"0 16px", display:"flex", gap:8 }}>
              <div style={{ flex:1, display:"flex", alignItems:"center", background:T.input, borderRadius:12, border:`1.5px solid ${T.border}`, padding:"0 14px", transition:"border-color 0.2s" }}>
                <span style={{fontSize:16, color:T.textSub, marginRight:8, flexShrink:0}}>ğŸ”</span>
                <input ref={searchRef} type="text" value={query} onChange={e=>setQuery(e.target.value)} onKeyDown={handleKeyDown}
                  placeholder="ê°€ê²Œ, ì¹´í˜, íšŒì‚¬ ì´ë¦„ ê²€ìƒ‰..."
                  style={{ flex:1, border:"none", background:"transparent", outline:"none", fontSize:15, color:T.text, padding:"12px 0", fontFamily:"inherit" }} />
                {query && (
                  <button onClick={()=>{ setQuery(""); setResults([]); setSelectedPlace(null); setHasSearched(false); clearMarkers(); }}
                    style={{background:"none",border:"none",fontSize:16,color:T.textSub,cursor:"pointer",padding:4}}>âœ•</button>
                )}
              </div>
              <button onClick={doSearch} disabled={searching || !query.trim()}
                style={{ padding:"0 18px", background: (!query.trim() || searching) ? T.border : T.gradient, color:"#fff", border:"none", borderRadius:12, fontSize:14, fontWeight:700, cursor: (!query.trim()||searching)?"default":"pointer", minHeight:48, flexShrink:0, opacity:(!query.trim()||searching)?0.6:1 }}>
                {searching ? "..." : "ê²€ìƒ‰"}
              </button>
            </div>
          </div>

          {/* ì§€ë„ ì˜ì—­ */}
          <div style={{flex:1, position:"relative", overflow:"hidden"}}>
            <div ref={mapRef} style={{width:"100%", height:"100%"}}/>

            {/* ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ / ì—ëŸ¬ */}
            {hasSearched && !searching && results.length === 0 && !selectedPlace && (
              <div style={{ position:"absolute", bottom:16, left:16, right:16, background:T.card, borderRadius:14, padding:"16px", boxShadow:"0 4px 20px rgba(0,0,0,0.1)", border:`1px solid ${T.border}`, textAlign:"center" }}>
                <div style={{fontSize:14, color:T.textSub}}>{searchError || "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤"}</div>
                <div style={{fontSize:12, color:T.textMuted, marginTop:4}}>ì§€ë„ë¥¼ ì§ì ‘ ëˆŒëŸ¬ ì¥ì†Œë¥¼ ì„ íƒí•  ìˆ˜ë„ ìˆì–´ìš”</div>
              </div>
            )}

            {/* ì„ íƒëœ ì¥ì†Œ (ë¦¬ìŠ¤íŠ¸ê°€ ì—†ì„ ë•Œ â€” ì§€ë„ ì§ì ‘ í´ë¦­) */}
            {selectedPlace && results.length === 0 && (
              <div style={{ position:"absolute", bottom:16, left:16, right:16, background:T.card, borderRadius:14, padding:"12px 16px", boxShadow:"0 4px 20px rgba(0,0,0,0.12)", border:`1px solid ${T.border}` }}>
                <div style={{fontSize:11, color:T.accent, fontWeight:700, marginBottom:3}}>ğŸ“ ì„ íƒí•œ ìœ„ì¹˜</div>
                <div style={{fontSize:14, fontWeight:700, color:T.text}}>{selectedPlace.name}</div>
                <div style={{fontSize:12, color:T.textSub, marginTop:2}}>{selectedPlace.address}</div>
              </div>
            )}
          </div>

          {/* í•˜ë‹¨ ì˜ì—­: ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ + í™•ì¸ ë²„íŠ¼ (í•­ìƒ í™”ë©´ ë‚´ì— ìœ„ì¹˜) */}
          <div style={{ flexShrink:0, background:T.card, borderTop:`1px solid ${T.border}`, paddingBottom:`env(safe-area-inset-bottom, 0px)` }}>
            {/* ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */}
            {results.length > 0 && (
              <div style={{ maxHeight:"35vh", overflow:"hidden", display:"flex", flexDirection:"column" }}>
                <div style={{display:"flex", justifyContent:"center", padding:"8px 0 4px"}}>
                  <div style={{width:36, height:4, borderRadius:2, background:T.border}}/>
                </div>
                <div style={{fontSize:12, color:T.textSub, fontWeight:600, padding:"0 16px 6px"}}>{results.length}ê°œ ê²€ìƒ‰ ê²°ê³¼</div>
                <div style={{overflowY:"auto", padding:"0 12px 8px", flex:1}}>
                  {results.map((p, i) => {
                    const isSel = selectedPlace && selectedPlace.lat === p.lat && selectedPlace.lng === p.lng;
                    return (
                      <button key={i} onClick={()=>selectFromList(p)}
                        style={{ width:"100%", display:"flex", alignItems:"center", gap:10, padding:"10px 12px", marginBottom:3, background: isSel ? T.accentBg : "transparent", border: isSel ? `1.5px solid ${T.accent}` : `1.5px solid transparent`, borderRadius:12, cursor:"pointer", textAlign:"left", transition:"all 0.15s" }}>
                        <div style={{ width:28, height:28, borderRadius:"50%", background: isSel ? T.accent : T.border, display:"flex", alignItems:"center", justifyContent:"center", color: isSel ? "#fff" : T.textSub, fontSize:13, fontWeight:700, flexShrink:0 }}>
                          {i + 1}
                        </div>
                        <div style={{overflow:"hidden", flex:1}}>
                          <div style={{fontSize:13, fontWeight:600, color: isSel ? T.accent : T.text, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.name}</div>
                          <div style={{fontSize:11, color:T.textSub, marginTop:1, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.address}</div>
                        </div>
                        {isSel && <span style={{fontSize:15, color:T.accent, flexShrink:0}}>âœ“</span>}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* í™•ì¸ ë²„íŠ¼ */}
            {selectedPlace && (
              <div style={{ padding:"10px 16px 14px" }}>
                <button onClick={()=>onSelect(selectedPlace)}
                  style={{ width:"100%", padding:14, background:T.gradient, color:"#fff", border:"none", borderRadius:14, fontSize:15, fontWeight:700, cursor:"pointer", minHeight:48 }}>
                  ì´ ì¥ì†Œë¡œ ê¸°ë¡í•˜ê¸° âœ“
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ========================================================
    // âœï¸ DiaryWritePage â€” ë„¤ì´ë²„ ì§€ë„ í”¼ì»¤ í†µí•© ë²„ì „
    // ========================================================
    function DiaryWritePage({onSave, onCancel, editData}) {
      const {user} = useAuth();
      const [title, setTitle] = useState(editData?.title||"");
      const [content, setContent] = useState(editData?.content||"");
      const [selEmotions, setSelEmotions] = useState(editData?.emotions||[]);
      const [selActivities, setSelActivities] = useState(editData?.activities||[]);
      const [places, setPlaces] = useState(editData?.places||[]);
      const [tab, setTab] = useState("emotion");
      const [saving, setSaving] = useState(false);
      const [openEmoGroup, setOpenEmoGroup] = useState(null);
      const [photoFile, setPhotoFile] = useState(null);
      const [photoPreview, setPhotoPreview] = useState(editData?.photo_url||null);
      // âœ… [ë³€ê²½] newPlace í…ìŠ¤íŠ¸ ì…ë ¥ â†’ ì§€ë„ í”¼ì»¤ ìƒíƒœë¡œ êµì²´
      const [showMapPicker, setShowMapPicker] = useState(false);

      const toggleEmo = k => {
        const ex = selEmotions.find(e=>e.key===k);
        if (ex) setSelEmotions(selEmotions.filter(e=>e.key!==k));
        else if (selEmotions.length < 5) setSelEmotions([...selEmotions, {key:k, intensity:2}]);
      };
      const setIntensity = (k,v) => setSelEmotions(selEmotions.map(e=>e.key===k?{...e,intensity:v}:e));
      const toggleAct = a => setSelActivities(selActivities.includes(a)?selActivities.filter(x=>x!==a):[...selActivities,a]);

      // âœ… [ë³€ê²½] addPlace â€” ì§€ë„ í”¼ì»¤ì—ì„œ ì„ íƒí•œ ì¥ì†Œ ê°ì²´ë¥¼ ë°›ì•„ì„œ ì¶”ê°€
      const addPlace = (place) => {
        setPlaces(prev => [...prev, { name: place.name, address: place.address, lat: place.lat, lng: place.lng, isFirst: false }]);
        setShowMapPicker(false);
      };

      const handleSave = async () => {
        if (!title.trim()||!content.trim()||selEmotions.length===0) {
          alert("ì œëª©, ë‚´ìš©, ê°ì •ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
        }
        setSaving(true);
        let photo_url = photoPreview;
        // ìƒˆ ì‚¬ì§„ íŒŒì¼ì´ ìˆìœ¼ë©´ Supabase Storageì— ì—…ë¡œë“œ
        if (photoFile) {
          try {
            const ext = photoFile.name.split('.').pop();
            const path = `diary_photos/${user.id}/${today()}_${Date.now()}.${ext}`;
            const { data: upData, error: upErr } = await sb.storage.from('diary-photos').upload(path, photoFile, { upsert: true });
            if (upErr) { console.error("ì‚¬ì§„ ì—…ë¡œë“œ ì˜¤ë¥˜:", upErr); }
            else {
              const { data: urlData } = sb.storage.from('diary-photos').getPublicUrl(path);
              photo_url = urlData?.publicUrl || null;
            }
          } catch(e) { console.error("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:", e); }
        }
        await onSave({ title, content, emotions:selEmotions, activities:selActivities, places, photo_url: photo_url || null, date:today() });
        setSaving(false);
      };

      const sec = {background:T.card, borderRadius:16, padding:"18px 20px", marginBottom:14, boxShadow:T.shadow};
      const inp = { width:"100%", padding:"12px 14px", borderRadius:12, border:`1px solid ${T.border}`, background:T.bg, fontSize:16, color:T.text, outline:"none", boxSizing:"border-box", WebkitAppearance:"none" };

      return (
        <>
          {/* âœ… [ì¶”ê°€] ì§€ë„ í”¼ì»¤ â€” ì „ì²´í™”ë©´ìœ¼ë¡œ ìœ„ì— ëœ¸ */}
          {showMapPicker && (
            <NaverMapPicker
              onSelect={addPlace}
              onClose={() => setShowMapPicker(false)}
            />
          )}

          <div style={{position:"fixed", inset:0, background:T.bg, zIndex:100, display:"flex", flexDirection:"column"}}>
            {/* í—¤ë” */}
            <div style={{ background:T.card, borderBottom:`1px solid ${T.border}`, padding:"0 20px", paddingTop:`calc(env(safe-area-inset-top,0px) + 12px)`, paddingBottom:12, display:"flex", alignItems:"center", justifyContent:"space-between", flexShrink:0 }}>
              <button onClick={onCancel} style={{background:"none", border:"none", color:T.textSub, fontSize:15, cursor:"pointer", padding:"8px 0", minWidth:60, minHeight:44, textAlign:"left"}}>â† ì·¨ì†Œ</button>
              <div style={{fontSize:16, fontWeight:700, color:T.text}}>{editData?"ì¼ê¸° ìˆ˜ì •":"ì˜¤ëŠ˜ì˜ í•˜ë£¨"}</div>
              <button onClick={handleSave} disabled={saving} style={{background:T.accent, color:"#fff", border:"none", borderRadius:10, padding:"9px 18px", fontSize:14, fontWeight:700, cursor:"pointer", minHeight:44, opacity:saving?0.7:1}}>
                {saving?"ì €ì¥ ì¤‘...":"ì €ì¥"}
              </button>
            </div>

            {/* ìŠ¤í¬ë¡¤ ë³¸ë¬¸ */}
            <div style={{flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch", padding:"20px 16px", paddingBottom:`calc(env(safe-area-inset-bottom,0px) + 20px)`}}>
              <div style={{fontSize:13, color:T.textSub, textAlign:"center", marginBottom:16}}>{fmtFull(today())}</div>

              {/* ì œëª© */}
              <div style={sec}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:8}}>ì˜¤ëŠ˜ì˜ ì œëª©</div>
                <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´?" style={inp}/>
              </div>

              {/* ë³¸ë¬¸ */}
              <div style={sec}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:8}}>ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°</div>
                <textarea value={content} onChange={e=>setContent(e.target.value)} placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ì†”ì§í•˜ê²Œ ì ì–´ë³´ì„¸ìš”." rows={5}
                  style={{...inp, resize:"none", lineHeight:1.7, fontFamily:"'Noto Sans KR',sans-serif"}}/>
              </div>

              {/* ê°ì • / í™œë™ íƒ­ */}
              <div style={sec}>
                <div style={{display:"flex", borderBottom:`1px solid ${T.border}`, marginBottom:14}}>
                  {["emotion","activity"].map(t=>(
                    <button key={t} onClick={()=>setTab(t)}
                      style={{flex:1, padding:"10px 0", border:"none", background:"none", fontSize:14, fontWeight:tab===t?700:500, color:tab===t?T.accent:T.textSub, borderBottom:`2px solid ${tab===t?T.accent:"transparent"}`, cursor:"pointer", marginBottom:-1}}>
                      {t==="emotion"?"ê°ì •":"í™œë™"}
                    </button>
                  ))}
                </div>
                {tab==="emotion" && (<>
                  <div style={{fontSize:12, color:T.textSub, marginBottom:10}}>ì˜¤ëŠ˜ ëŠë‚€ ê°ì •ì„ ì„ íƒí•´ë³´ì„¸ìš” (ìµœëŒ€ 5ê°œ)</div>
                  {/* ì„ íƒëœ ê°ì •ì´ ìˆìœ¼ë©´ ìƒë‹¨ì— í‘œì‹œ */}
                  {selEmotions.length>0 && (
                    <div style={{display:"flex", flexWrap:"wrap", gap:6, marginBottom:12, padding:"10px 12px", background:T.accentBg, borderRadius:12}}>
                      {selEmotions.map(e=>(
                        <button key={e.key} onClick={()=>toggleEmo(e.key)}
                          style={{padding:"5px 10px", borderRadius:16, border:`1.5px solid ${EMOTIONS[e.key].color}`, background:EMOTIONS[e.key].color+"22", fontSize:12, cursor:"pointer", color:T.text, fontWeight:600, display:"flex", alignItems:"center", gap:4}}>
                          {EMOTIONS[e.key].emoji} {EMOTIONS[e.key].label} <span style={{fontSize:10, opacity:0.6}}>âœ•</span>
                        </button>
                      ))}
                      <span style={{fontSize:11, color:T.textSub, alignSelf:"center"}}>{selEmotions.length}/5</span>
                    </div>
                  )}
                  {/* ê°ì • ê·¸ë£¹ì„ ì•„ì½”ë””ì–¸ìœ¼ë¡œ í‘œì‹œ */}
                  {EMOTION_CATEGORIES.map((cat, ci) => (
                    <div key={ci} style={{marginBottom:10}}>
                      <div style={{fontSize:11, fontWeight:700, color:T.accent, marginBottom:6, padding:"4px 0"}}>{cat.label}</div>
                      <div style={{display:"flex", flexWrap:"wrap", gap:6}}>
                        {cat.groups.map((g, gi) => {
                          const hasSelected = g.emotions.some(emo => selEmotions.find(x=>x.key===emo.key));
                          const isOpen = openEmoGroup === `${ci}-${gi}`;
                          return (
                            <React.Fragment key={gi}>
                              <button onClick={()=>setOpenEmoGroup(isOpen?null:`${ci}-${gi}`)}
                                style={{padding:"8px 14px", borderRadius:20, border:`1.5px solid ${hasSelected?g.color:isOpen?g.color:T.border}`, background:hasSelected?g.color+"22":isOpen?g.color+"11":T.bg, fontSize:12, cursor:"pointer", color:hasSelected||isOpen?T.text:T.textSub, fontWeight:hasSelected?700:isOpen?600:400, minHeight:36, display:"flex", alignItems:"center", gap:4, transition:"all 0.15s"}}>
                                {g.emotions[0].emoji} {g.group} {hasSelected && <span style={{fontSize:10, background:g.color, color:"#fff", borderRadius:10, padding:"1px 6px", fontWeight:700}}>{g.emotions.filter(emo=>selEmotions.find(x=>x.key===emo.key)).length}</span>}
                                <span style={{fontSize:10, marginLeft:2, transition:"transform 0.2s", transform:isOpen?"rotate(180deg)":"rotate(0deg)"}}>â–¼</span>
                              </button>
                            </React.Fragment>
                          );
                        })}
                      </div>
                      {/* ì—´ë¦° ê·¸ë£¹ì˜ ê°ì • ëª©ë¡ */}
                      {cat.groups.map((g, gi) => {
                        const isOpen = openEmoGroup === `${ci}-${gi}`;
                        if (!isOpen) return null;
                        return (
                          <div key={`detail-${gi}`} style={{marginTop:8, padding:"10px 12px", background:g.color+"0D", borderRadius:12, border:`1px solid ${g.color}33`, animation:"fadeIn 0.2s ease"}}>
                            <div style={{display:"flex", flexWrap:"wrap", gap:6}}>
                              {g.emotions.map(emo => {
                                const sel = selEmotions.find(x=>x.key===emo.key);
                                return (
                                  <button key={emo.key} onClick={()=>toggleEmo(emo.key)}
                                    style={{padding:"8px 14px", borderRadius:20, border:`1.5px solid ${sel?g.color:T.border}`, background:sel?g.color+"22":"#fff", fontSize:13, cursor:"pointer", color:sel?T.text:T.textSub, fontWeight:sel?600:400, minHeight:38, transition:"all 0.15s"}}>
                                    {emo.emoji} {emo.label}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                  {selEmotions.length>0 && (
                    <div style={{display:"flex", flexDirection:"column", gap:12}}>
                      {selEmotions.map(e=>(
                        <div key={e.key}>
                          <div style={{fontSize:13, fontWeight:600, color:T.text, marginBottom:6}}>{EMOTIONS[e.key].emoji} {EMOTIONS[e.key].label} ê°•ë„</div>
                          <div style={{display:"flex", gap:6}}>
                            {INTENSITY.map((label,i)=>(
                              <button key={i} onClick={()=>setIntensity(e.key,i+1)}
                                style={{flex:1, padding:"8px 4px", borderRadius:8, border:`1px solid ${e.intensity===i+1?EMOTIONS[e.key].color:T.border}`, background:e.intensity===i+1?EMOTIONS[e.key].color+"33":"transparent", fontSize:11, color:e.intensity===i+1?T.text:T.textSub, cursor:"pointer", fontWeight:e.intensity===i+1?700:400, minHeight:40}}>
                                {label}
                              </button>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </>)}
                {tab==="activity" && (
                  <div style={{display:"flex", flexWrap:"wrap", gap:8}}>
                    {ACTIVITIES.map(a=>{
                      const sel=selActivities.includes(a);
                      return (
                        <button key={a} onClick={()=>toggleAct(a)}
                          style={{padding:"9px 14px", borderRadius:20, border:`1.5px solid ${sel?T.accent:T.border}`, background:sel?T.accentBg:T.bg, fontSize:13, cursor:"pointer", color:sel?T.accent:T.textSub, fontWeight:sel?600:400, minHeight:40}}>
                          {a}
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>

              {/* âœ… [ë³€ê²½] ë°©ë¬¸ ì¥ì†Œ ì„¹ì…˜ â€” í…ìŠ¤íŠ¸ ì…ë ¥ â†’ ë„¤ì´ë²„ ì§€ë„ í”¼ì»¤ ë²„íŠ¼ */}
              <div style={sec}>
                <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12}}>
                  <div style={{fontSize:13, fontWeight:700, color:T.text}}>ğŸ“ ì˜¤ëŠ˜ ë°©ë¬¸í•œ ê³³</div>
                  <button onClick={()=>setShowMapPicker(true)}
                    style={{ padding:"9px 16px", background:T.accent, color:"#fff", border:"none", borderRadius:10, fontSize:13, fontWeight:700, cursor:"pointer", minHeight:36, display:"flex", alignItems:"center", gap:4 }}>
                    ğŸ—ºï¸ ì¥ì†Œ ì¶”ê°€
                  </button>
                </div>

                {/* ì¶”ê°€ëœ ì¥ì†Œ ëª©ë¡ */}
                {places.length === 0 ? (
                  <div style={{textAlign:"center", padding:"16px 0", color:T.textSub, fontSize:13}}>
                    ì§€ë„ì—ì„œ ë°©ë¬¸í•œ ì¥ì†Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”
                  </div>
                ) : (
                  <div style={{display:"flex", flexDirection:"column", gap:8}}>
                    {places.map((p,i)=>(
                      <div key={i} style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"10px 14px", background:T.bg, borderRadius:12, border:`1px solid ${T.border}` }}>
                        <div style={{display:"flex", alignItems:"center", gap:8, overflow:"hidden"}}>
                          <span style={{fontSize:16, flexShrink:0}}>ğŸ“</span>
                          <div style={{overflow:"hidden"}}>
                            <div style={{fontSize:14, fontWeight:600, color:T.text, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.name}</div>
                            {p.address && <div style={{fontSize:11, color:T.textSub, marginTop:1, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis"}}>{p.address}</div>}
                          </div>
                        </div>
                        <button onClick={()=>setPlaces(places.filter((_,j)=>j!==i))}
                          style={{background:"none", border:"none", fontSize:18, color:T.textSub, cursor:"pointer", flexShrink:0, minWidth:36, minHeight:36, display:"flex", alignItems:"center", justifyContent:"center"}}>
                          Ã—
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* ì˜¤ëŠ˜ì˜ ì‚¬ì§„ */}
              <div style={sec}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:10}}>ğŸ“· ì˜¤ëŠ˜ì˜ ì‚¬ì§„</div>
                {photoPreview ? (
                  <div style={{position:"relative"}}>
                    <img src={photoPreview} alt="ì˜¤ëŠ˜ì˜ ì‚¬ì§„" style={{width:"100%", borderRadius:12, maxHeight:300, objectFit:"cover"}}/>
                    <button onClick={()=>{setPhotoFile(null); setPhotoPreview(null);}}
                      style={{position:"absolute", top:8, right:8, width:32, height:32, borderRadius:"50%", background:"rgba(0,0,0,0.5)", color:"#fff", border:"none", fontSize:16, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center"}}>Ã—</button>
                  </div>
                ) : (
                  <label style={{display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", padding:"28px 16px", border:`2px dashed ${T.border}`, borderRadius:14, cursor:"pointer", background:T.bg, transition:"all 0.2s"}}>
                    <span style={{fontSize:32, marginBottom:8}}>ğŸ“·</span>
                    <span style={{fontSize:13, color:T.textSub, fontWeight:500}}>ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                    <span style={{fontSize:11, color:T.textMuted, marginTop:4}}>ìµœëŒ€ 2MB Â· JPG, PNG, WEBP</span>
                    <input type="file" accept="image/jpeg,image/png,image/webp" style={{display:"none"}}
                      onChange={e=>{
                        const file = e.target.files?.[0];
                        if (!file) return;
                        if (file.size > 2*1024*1024) { alert("ì‚¬ì§„ í¬ê¸°ê°€ 2MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë” ì‘ì€ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
                        setPhotoFile(file);
                        const reader = new FileReader();
                        reader.onload = ev => setPhotoPreview(ev.target.result);
                        reader.readAsDataURL(file);
                      }}/>
                  </label>
                )}
              </div>
            </div>
          </div>
        </>
      );
    }

    // ========================================================
    // ğŸ“Š WeeklyAISummary â€” ìµœê·¼ 7ì¼ ì¼ê¸° ìë™ AI ë¶„ì„ ì¹´ë“œ
    // ========================================================
    function WeeklyAISummary({ diaries }) {
      const last7 = diaries.filter(d => {
        const days = Math.floor((new Date() - new Date(d.date + "T00:00:00")) / 86400000);
        return days < 7;
      });
      const cacheKey = `gyeol_weekly_${last7.map(d=>d.date).sort().join(",")}`;
      const [summary, setSummary] = useState(null);
      const [loading, setLoading] = useState(false);
      const [expanded, setExpanded] = useState(false);

      // cacheKeyê°€ ë°”ë€” ë•Œë§Œ ì‹¤í–‰ â€” ìºì‹œ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ, ì—†ìœ¼ë©´ API í˜¸ì¶œ
      useEffect(() => {
        if (last7.length === 0) return;
        try {
          const hit = localStorage.getItem(cacheKey);
          if (hit) { setSummary(hit); setExpanded(true); return; }
        } catch {}
        // ìºì‹œ ì—†ìœ¼ë©´ ìƒì„±
        setSummary(null);
        (async () => {
          setLoading(true); setExpanded(true);
          const ctx = last7.map(d =>
            `[${d.date}] ê°ì •: ${(d.emotions||[]).map(e=>`${EMOTIONS[e.key]?.label}(ê°•ë„${e.intensity})`).join(", ")||"ì—†ìŒ"} / í™œë™: ${(d.activities||[]).join(", ")||"ì—†ìŒ"}`
          ).join("\n");
          const prompt = `ì•„ë˜ ìµœê·¼ 7ì¼ ì¼ê¸°ë¥¼ ë”°ëœ»í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”. ì „ì²´ 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ.\n\n${ctx}\n\nğŸ’œ ì´ë²ˆ ì£¼ ê°ì • íë¦„ í•œ ì¤„\nğŸƒ ë§ì´ í•œ í™œë™ í•œ ì¤„\nğŸŒ± í•œë§ˆë”” ì‘ì› (ìŠ¬í””Â·ë¶ˆì•ˆì´ ì£¼ë¥¼ ì´ë£¨ë©´ ì „ë¬¸ ìƒë‹´ ë¶€ë“œëŸ½ê²Œ ì œì•ˆ)`;
          try {
            const text = await callGemini(prompt);
            setSummary(text);
            try { localStorage.setItem(cacheKey, text); } catch {}
          } catch {}
          setLoading(false);
        })();
      }, [cacheKey]);

      if (last7.length === 0) return null;

      return (
        <div style={{ background:"linear-gradient(135deg,#4A3728,#7A5C44)", borderRadius:16, padding:"16px 18px", marginBottom:14, color:"#fff", boxShadow:"0 4px 20px rgba(74,55,40,0.3)" }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
            <div>
              <div style={{ fontSize:14, fontWeight:800, marginBottom:2 }}>âœ¨ ì´ë²ˆ ì£¼ ë‚˜ì˜ ê²°</div>
              <div style={{ fontSize:11, opacity:0.75 }}>ìµœê·¼ 7ì¼ AI ë¶„ì„ Â· {last7.length}ê°œ ì¼ê¸°</div>
            </div>
            <button
              onClick={() => setExpanded(e=>!e)}
              style={{ background:"rgba(255,255,255,0.18)", border:"none", borderRadius:10, padding:"7px 13px", color:"#fff", fontSize:12, fontWeight:700, cursor:"pointer", minHeight:34, opacity:loading?0.7:1 }}>
              {loading ? "ë¶„ì„ ì¤‘..." : expanded ? "ì ‘ê¸° â–²" : "í¼ì¹˜ê¸° â–¼"}
            </button>
          </div>
          {loading && (
            <div style={{ marginTop:14, fontSize:13, opacity:0.85, textAlign:"center", padding:"8px 0" }}>ğŸ¤– AIê°€ ì¼ê¸°ë¥¼ ì½ê³  ìˆì–´ìš”...</div>
          )}
          {summary && expanded && (
            <div style={{ marginTop:14, fontSize:13, lineHeight:1.85, whiteSpace:"pre-line", opacity:0.95, borderTop:"1px solid rgba(255,255,255,0.2)", paddingTop:14 }}>{summary}</div>
          )}
        </div>
      );
    }

    // ========================================================
    // ğŸ¤– DiaryAIModal â€” ì¼ê¸° 1ê°œ AI ë¶„ì„ ë°”í…€ì‹œíŠ¸
    // ========================================================
    function DiaryAIModal({ diary, onClose, onAnalysisSaved }) {
      const cacheKey = `gyeol_ai_${diary.date}`;
      const initial = diary.ai_analysis || (() => { try { return localStorage.getItem(cacheKey); } catch { return null; } })();
      const [analysis, setAnalysis] = useState(initial || null);
      const [loading, setLoading] = useState(!initial);
      const [cached, setCached] = useState(!!initial);

      useEffect(() => {
        if (initial) return; // ìºì‹œëœ ë¶„ì„ ìˆìœ¼ë©´ API í˜¸ì¶œ ì•ˆ í•¨
        (async () => {
          try {
            const ctx = `ë‚ ì§œ: ${diary.date}\nì œëª©: ${diary.title}\në‚´ìš©: ${(diary.content||"").slice(0,200)}\nê°ì •: ${(diary.emotions||[]).map(e=>`${EMOTIONS[e.key]?.label}(ê°•ë„${e.intensity})`).join(", ")||"ì—†ìŒ"}\ní™œë™: ${(diary.activities||[]).join(", ")||"ì—†ìŒ"}`;
            const prompt = `ì•„ë˜ í•˜ë£¨ ì¼ê¸°ë¥¼ ë”°ëœ»í•˜ê³  ê³µê° ìˆê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”. ì „ì²´ 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ.\n\n${ctx}\n\nğŸ’œ ê°ì • í•œ ì¤„\nâœ¨ ì˜¤ëŠ˜ì˜ í•˜ì´ë¼ì´íŠ¸ í•œ ì¤„\nğŸŒ± ë‚´ì¼ì„ ìœ„í•œ í•œë§ˆë”” (ë¶€ì •ì  ê°ì •ì´ ê°•í•˜ë©´ ìƒë‹´ ì œì•ˆ í¬í•¨)`;
            const text = await callGemini(prompt);
            setAnalysis(text);
            try { localStorage.setItem(cacheKey, text); } catch {}
            if (onAnalysisSaved) onAnalysisSaved(diary.id, text);
            sb.from('diary_entries').update({ ai_analysis: text }).eq('id', diary.id);
          } catch (e) {
            setAnalysis("ë¶„ì„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          } finally {
            setLoading(false);
          }
        })();
      }, []);

      return (
        <div style={{ position:"fixed", inset:0, background:"rgba(74,55,40,0.6)", zIndex:250, display:"flex", flexDirection:"column", justifyContent:"flex-end" }} onClick={onClose}>
          <div onClick={e=>e.stopPropagation()} style={{ background:T.card, borderRadius:"20px 20px 0 0", maxHeight:"82vh", display:"flex", flexDirection:"column", boxShadow:"0 -8px 40px rgba(0,0,0,0.18)", paddingBottom:`env(safe-area-inset-bottom,0px)` }}>
            <div style={{ padding:"16px 20px", borderBottom:`1px solid ${T.border}`, display:"flex", justifyContent:"space-between", alignItems:"center", flexShrink:0 }}>
              <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                <div style={{ width:36, height:36, borderRadius:10, background:"linear-gradient(135deg,#4A3728,#7A5C44)", display:"flex", alignItems:"center", justifyContent:"center", fontSize:18 }}>ğŸ¤–</div>
                <div>
                  <div style={{ fontSize:15, fontWeight:700, color:T.text }}>AI ì¼ê¸° ë¶„ì„</div>
                  <div style={{ fontSize:11, color:T.textSub, marginTop:1, maxWidth:220, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>
                    {diary.title}
                    {cached && <span style={{ marginLeft:6, background:"#e8f5e9", color:"#2e7d32", borderRadius:6, padding:"1px 6px", fontSize:10, fontWeight:700 }}>ì €ì¥ë¨</span>}
                  </div>
                </div>
              </div>
              <button onClick={onClose} style={{ background:"none", border:"none", fontSize:22, cursor:"pointer", color:T.textSub, minWidth:44, minHeight:44, display:"flex", alignItems:"center", justifyContent:"center" }}>Ã—</button>
            </div>
            <div style={{ flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch", padding:20 }}>
              {loading ? (
                <div style={{ textAlign:"center", padding:"50px 0", color:T.textSub }}>
                  <div style={{ fontSize:44, marginBottom:14, animation:"pulse 1.5s infinite" }}>ğŸ¤–</div>
                  <div style={{ fontSize:14, fontWeight:600, color:T.text, marginBottom:6 }}>AIê°€ ì¼ê¸°ë¥¼ ì½ê³  ìˆì–´ìš”</div>
                  <div style={{ fontSize:12, opacity:0.7 }}>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
                </div>
              ) : (
                <div style={{ fontSize:14, lineHeight:1.9, color:T.text, whiteSpace:"pre-line" }}>{analysis}</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ========================================================
    // ğŸ—ºï¸ NaverMapView â€” ì €ì¥ëœ ì¢Œí‘œë¥¼ ë„¤ì´ë²„ ì§€ë„ë¡œ í‘œì‹œ
    // ========================================================
    function NaverMapView({ lat, lng }) {
      const divRef = useRef(null);
      useEffect(() => {
        if (!divRef.current || !window.naver?.maps || !lat || !lng) return;
        const ll = new window.naver.maps.LatLng(lat, lng);
        const map = new window.naver.maps.Map(divRef.current, {
          center: ll,
          zoom: 17,
          mapDataControl: false,
          scaleControl: false,
          mapTypeControl: false,
        });
        new window.naver.maps.Marker({ position: ll, map });
      }, [lat, lng]);

      if (!lat || !lng) return null;
      return <div ref={divRef} style={{ width:"100%", height:200 }} />;
    }

    // ========================================================
    // ğŸ“– DiaryDetail â€” ì¥ì†Œ í‘œì‹œ ì‹œ address í•„ë“œë„ ë³´ì—¬ì¤Œ
    // ========================================================
    function DiaryDetail({diary, onBack}) {
      return (
        <div style={{position:"fixed", inset:0, background:T.bg, zIndex:50, display:"flex", flexDirection:"column"}}>
          <div style={{ background:T.card, borderBottom:`1px solid ${T.border}`, padding:"0 20px", paddingTop:`calc(env(safe-area-inset-top,0px) + 12px)`, paddingBottom:12, display:"flex", alignItems:"center", gap:10, flexShrink:0 }}>
            <button onClick={onBack} style={{background:"none", border:"none", color:T.textSub, fontSize:22, cursor:"pointer", minWidth:44, minHeight:44, display:"flex", alignItems:"center"}}>â†</button>
            <div style={{flex:1, fontSize:16, fontWeight:700, color:T.text, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>{diary.title}</div>
          </div>
          <div style={{flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch", padding:"20px 16px", paddingBottom:`calc(env(safe-area-inset-bottom,0px) + 20px)`}}>
            <div style={{fontSize:13, color:T.textSub, marginBottom:4}}>{fmtFull(diary.date)}</div>
            <div style={{background:T.card, borderRadius:16, padding:20, marginBottom:12, boxShadow:T.shadow}}>
              <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:8}}>ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°</div>
              <div style={{fontSize:14, color:T.text, lineHeight:1.8, whiteSpace:"pre-line"}}>{diary.content}</div>
            </div>
            <div style={{background:T.card, borderRadius:16, padding:20, marginBottom:12, boxShadow:T.shadow}}>
              <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:12}}>ê°ì •</div>
              {(diary.emotions||[]).map(e=>(
                <div key={e.key} style={{marginBottom:10}}>
                  <div style={{fontSize:13, fontWeight:600, marginBottom:5, color:T.text}}>{EMOTIONS[e.key]?.emoji} {EMOTIONS[e.key]?.label}</div>
                  <div style={{height:7, borderRadius:4, background:T.border}}>
                    <div style={{height:"100%", borderRadius:4, background:EMOTIONS[e.key]?.color, width:`${e.intensity*25}%`}}/>
                  </div>
                </div>
              ))}
            </div>
            {(diary.activities||[]).length>0 && (
              <div style={{background:T.card, borderRadius:16, padding:20, marginBottom:12, boxShadow:T.shadow}}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:10}}>í™œë™</div>
                <div style={{display:"flex", flexWrap:"wrap", gap:6}}>
                  {(diary.activities||[]).map(a=>(
                    <span key={a} style={{padding:"7px 12px", borderRadius:14, background:T.accentBg, fontSize:13, color:T.accent, fontWeight:500}}>{a}</span>
                  ))}
                </div>
              </div>
            )}
            {/* âœ… ì¥ì†Œ ì„¹ì…˜ â€” address + êµ¬ê¸€ ì§€ë„ í‘œì‹œ */}
            {(diary.places||[]).length>0 && (
              <div style={{background:T.card, borderRadius:16, padding:20, marginBottom:12, boxShadow:T.shadow}}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:10}}>ë°©ë¬¸ ì¥ì†Œ</div>
                {diary.places.map((p,i)=>(
                  <div key={i} style={{marginBottom:16}}>
                    <div style={{display:"flex", alignItems:"flex-start", gap:8, marginBottom:8}}>
                      <span style={{fontSize:16, marginTop:1}}>ğŸ“</span>
                      <div>
                        <div style={{fontSize:14, color:T.text, fontWeight:600}}>{p.name}</div>
                        {p.address && <div style={{fontSize:12, color:T.textSub, marginTop:2}}>{p.address}</div>}
                      </div>
                      {p.isFirst && <span style={{padding:"2px 8px", borderRadius:8, background:"#E8F5E9", color:"#4CAF50", fontSize:10, fontWeight:700, flexShrink:0}}>ì²« ë°©ë¬¸</span>}
                    </div>
                    {p.lat && p.lng && (
                      <div style={{borderRadius:12, overflow:"hidden", border:`1px solid ${T.border}`}}>
                        <NaverMapView lat={p.lat} lng={p.lng} />
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
            {diary.photo_url && (
              <div style={{background:T.card, borderRadius:16, padding:20, boxShadow:T.shadow}}>
                <div style={{fontSize:13, fontWeight:700, color:T.text, marginBottom:10}}>ğŸ“· ì˜¤ëŠ˜ì˜ ì‚¬ì§„</div>
                <img src={diary.photo_url} alt="ì˜¤ëŠ˜ì˜ ì‚¬ì§„" style={{width:"100%", borderRadius:12, maxHeight:400, objectFit:"cover"}}/>
              </div>
            )}
          </div>
        </div>
      );
    }

    function AIChatModal({onClose, diaries}) {
      const [msgs, setMsgs] = useState([{role:"ai", text:"ì•ˆë…•í•˜ì„¸ìš”! GYEOL AIì˜ˆìš” â˜•\n\nê¸°ë¡ëœ ì¼ê¸°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¹ì‹ ì˜ ê²°ì„ í•¨ê»˜ ë“¤ì—¬ë‹¤ë³¼ê²Œìš”.\n\nì´ëŸ° ê±¸ ë¬¼ì–´ë³¼ ìˆ˜ ìˆì–´ìš”:\nâ€¢ \"ë‚´ ê°ì • íŒ¨í„´ì´ ì–´ë•Œ?\"\nâ€¢ \"ìì£¼ ë°©ë¬¸í•œ ê³³ì€ ì–´ë””ì•¼?\"\nâ€¢ \"ë‚´ ê²°ì„ ë¶„ì„í•´ì¤˜\"\nâ€¢ \"ìš”ì¦˜ ë‚´ ê¸°ë¶„ì€ ì–´ë–¤ í¸ì´ì•¼?\""}]);
      const [input, setInput] = useState(""); const [loading, setLoading] = useState(false);
      const ref = useRef(null);
      useEffect(()=>{ref.current?.scrollTo(0, ref.current.scrollHeight);},[msgs]);

      const buildContext = () => {
        const recent = diaries.slice(0, 20);
        if (recent.length === 0) return "ì•„ì§ ê¸°ë¡ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return recent.map(d =>
          `[${d.date}] "${d.title}" ê°ì •: ${(d.emotions||[]).map(e=>`${EMOTIONS[e.key]?.label||e.key}(ê°•ë„${e.intensity})`).join(", ")||"ì—†ìŒ"} / í™œë™: ${(d.activities||[]).join(", ")||"ì—†ìŒ"} / ì¥ì†Œ: ${(d.places||[]).map(p=>p.name).join(", ")||"ì—†ìŒ"}`
        ).join("\n");
      };

      const send = async () => {
        if (!input.trim()||loading) return;
        const q = input; setInput(""); setMsgs(p=>[...p,{role:"user",text:q}]); setLoading(true);
        try {
          const ctx = buildContext();
          const chatHistory = msgs.filter(m=>m.role!=="system").slice(-6).map(m=>`${m.role==="user"?"ì‚¬ìš©ì":"AI"}: ${m.text}`).join("\n");
          const prompt = `ë‹¹ì‹ ì€ GYEOL AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì¼ê¸° ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë”°ëœ»í•˜ê³  ê³µê° ìˆê²Œ ëŒ€í™”í•˜ëŠ” ê°ì • ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” ì‚¬ìš©ìì˜ ìµœê·¼ ì¼ê¸° ê¸°ë¡ì…ë‹ˆë‹¤:
${ctx}

ìµœê·¼ ëŒ€í™”:
${chatHistory}

ì‚¬ìš©ìì˜ ì§ˆë¬¸: ${q}

ìœ„ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë”°ëœ»í•˜ê³  ê³µê° ìˆê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ. ê°ì • íŒ¨í„´, í™œë™ íŒ¨í„´, ì¥ì†Œ íŒ¨í„´ ë“±ì„ ë¶„ì„í•´ì„œ ë‹µë³€í•´ì£¼ì„¸ìš”. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`;
          const text = await callGemini(prompt);
          setMsgs(p=>[...p,{role:"ai",text}]);
        } catch(e) {
          setMsgs(p=>[...p,{role:"ai",text:"ì£„ì†¡í•´ìš”, ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” â˜•"}]);
        }
        setLoading(false);
      };
      return (
        <div style={{position:"fixed", inset:0, background:"rgba(74,55,40,0.6)", zIndex:200, display:"flex", flexDirection:"column", justifyContent:"flex-end"}} onClick={onClose}>
          <div onClick={e=>e.stopPropagation()} style={{ background:T.card, borderRadius:"20px 20px 0 0", display:"flex", flexDirection:"column", maxHeight:"80vh", boxShadow:"0 -8px 40px rgba(0,0,0,0.15)", paddingBottom:`env(safe-area-inset-bottom,0px)` }}>
            <div style={{padding:"16px 20px", borderBottom:`1px solid ${T.border}`, display:"flex", justifyContent:"space-between", alignItems:"center", flexShrink:0}}>
              <div style={{display:"flex", alignItems:"center", gap:8}}><span style={{fontSize:18}}>â˜•</span><span style={{fontSize:16, fontWeight:700, color:T.text}}>ë‚˜ì˜ ê²° ë¶„ì„</span></div>
              <button onClick={onClose} style={{background:"none", border:"none", fontSize:22, cursor:"pointer", color:T.textSub, minWidth:44, minHeight:44, display:"flex", alignItems:"center", justifyContent:"center"}}>Ã—</button>
            </div>
            <div ref={ref} style={{flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch", padding:16, minHeight:200}}>
              {msgs.map((m,i)=>(
                <div key={i} style={{display:"flex", justifyContent:m.role==="user"?"flex-end":"flex-start", marginBottom:10}}>
                  <div style={{maxWidth:"82%", padding:"11px 15px", borderRadius:16, background:m.role==="user"?T.accent:T.bg, color:m.role==="user"?"#fff":T.text, fontSize:14, lineHeight:1.6, whiteSpace:"pre-line"}}>{m.text}</div>
                </div>
              ))}
              {loading && <div style={{display:"flex"}}><div style={{background:T.bg, padding:"11px 15px", borderRadius:16, fontSize:14, color:T.textSub}}>ë¶„ì„ ì¤‘... â˜•</div></div>}
            </div>
            <div style={{padding:"10px 14px", borderTop:`1px solid ${T.border}`, display:"flex", gap:8, flexShrink:0}}>
              <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==="Enter"&&send()} placeholder="ë‚˜ì˜ ê²°ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”..." style={{flex:1, padding:"12px 16px", borderRadius:22, border:`1px solid ${T.border}`, background:T.bg, fontSize:15, outline:"none", color:T.text}}/>
              <button onClick={send} style={{width:44, height:44, borderRadius:"50%", border:"none", background:input.trim()?T.accent:T.border, color:"#fff", cursor:"pointer", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0}}>â†‘</button>
            </div>
          </div>
        </div>
      );
    }

    function StatsTab({diaries}) {
      const [subTab, setSubTab] = useState("all");
      const allEmo = {}; diaries.forEach(d=>(d.emotions||[]).forEach(e=>{allEmo[e.key]=(allEmo[e.key]||0)+e.intensity;}));
      const emoSorted = Object.entries(allEmo).sort((a,b)=>b[1]-a[1]); const maxEmo = emoSorted[0]?.[1]||1;
      const allAct = {}; diaries.forEach(d=>(d.activities||[]).forEach(a=>{allAct[a]=(allAct[a]||0)+1;}));
      const actSorted = Object.entries(allAct).sort((a,b)=>b[1]-a[1]); const maxAct = actSorted[0]?.[1]||1;
      if (diaries.length===0) return (<div style={{padding:"80px 20px", textAlign:"center"}}><div style={{fontSize:48, marginBottom:16}}>âœ¨</div><div style={{fontSize:16, fontWeight:700, color:T.text, marginBottom:8}}>ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</div><div style={{fontSize:14, color:T.textSub, lineHeight:1.7}}>ì¼ê¸°ë¥¼ ì“°ê¸° ì‹œì‘í•˜ë©´<br/>ë‚˜ì˜ ê²°ì´ ë³´ì´ê¸° ì‹œì‘í•´ìš”.</div></div>);
      return (
        <div style={{padding:"20px 16px", paddingBottom:20}}>
          <div style={{fontSize:20, fontWeight:800, color:T.text, marginBottom:4}}>ë‚˜ì˜ ê²°</div>
          <div style={{fontSize:13, color:T.textSub, marginBottom:14}}>ê¸°ë¡ì´ ìŒ“ì¼ìˆ˜ë¡ ê²°ì´ ì„ ëª…í•´ì§‘ë‹ˆë‹¤</div>
          <div style={{display:"flex", gap:8, marginBottom:16, overflowX:"auto", paddingBottom:4}}>
            {[["all","ì „ì²´"],["emotion","ê°ì •"],["activity","í™œë™"]].map(([id,label])=>(
              <button key={id} onClick={()=>setSubTab(id)} style={{padding:"9px 18px", borderRadius:20, border:`1.5px solid ${subTab===id?T.accent:T.border}`, background:subTab===id?T.accentBg:T.card, color:subTab===id?T.accent:T.textSub, fontSize:13, fontWeight:subTab===id?700:500, cursor:"pointer", whiteSpace:"nowrap", minHeight:40, flexShrink:0}}>{label}</button>
            ))}
          </div>
          {(subTab==="all"||subTab==="emotion") && emoSorted.length>0 && (
            <div style={{background:T.card, borderRadius:16, padding:20, marginBottom:12, boxShadow:T.shadow}}>
              <div style={{fontSize:14, fontWeight:700, color:T.text, marginBottom:14}}>ğŸ­ ê°ì •ì˜ ê²°</div>
              <div style={{display:"flex", flexWrap:"wrap", gap:8, marginBottom:subTab==="emotion"?16:0}}>
                {emoSorted.map(([k,v])=>{const e=EMOTIONS[k]; if(!e) return null; return (<div key={k} style={{padding:"10px 14px", borderRadius:12, background:e.color+"22", textAlign:"center", border:`1px solid ${e.color}44`}}><div style={{fontSize:20}}>{e.emoji}</div><div style={{fontSize:11, fontWeight:600, color:T.text, marginTop:3}}>{e.label}</div><div style={{fontSize:10, color:T.textSub}}>{v}ì </div></div>);})}
              </div>
              {subTab==="emotion" && emoSorted.map(([k,v],i)=>{const e=EMOTIONS[k]; if(!e) return null; return (<div key={k} style={{display:"flex", alignItems:"center", gap:10, marginBottom:10}}><span style={{fontSize:12, fontWeight:700, color:T.textSub, minWidth:18}}>{i+1}</span><span style={{fontSize:16}}>{e.emoji}</span><span style={{fontSize:13, fontWeight:600, color:T.text, minWidth:50}}>{e.label}</span><div style={{flex:1, height:8, borderRadius:4, background:T.border}}><div style={{height:"100%", borderRadius:4, background:e.color, width:`${(v/maxEmo)*100}%`}}/></div><span style={{fontSize:12, color:T.textSub, minWidth:28, textAlign:"right"}}>{v}ì </span></div>);})}
            </div>
          )}
          {(subTab==="all"||subTab==="activity") && actSorted.length>0 && (
            <div style={{background:T.card, borderRadius:16, padding:20, boxShadow:T.shadow}}>
              <div style={{fontSize:14, fontWeight:700, color:T.text, marginBottom:12}}>ğŸƒ í™œë™ì˜ ê²°</div>
              <div style={{display:"flex", flexWrap:"wrap", gap:8, marginBottom:subTab==="activity"?16:0}}>
                {actSorted.map(([a,c])=>(<div key={a} style={{padding:"9px 14px", borderRadius:14, background:T.accentBg, display:"flex", alignItems:"center", gap:6, border:`1px solid ${T.accentLight}`}}><span style={{fontSize:13, fontWeight:600, color:T.text}}>{a}</span><span style={{fontSize:12, fontWeight:700, color:T.accent, background:T.card, padding:"1px 7px", borderRadius:8}}>{c}íšŒ</span></div>))}
              </div>
              {subTab==="activity" && actSorted.map(([a,c],i)=>(<div key={a} style={{display:"flex", alignItems:"center", gap:10, marginBottom:10}}><span style={{fontSize:12, fontWeight:700, color:T.textSub, minWidth:18}}>{i+1}</span><span style={{fontSize:13, fontWeight:600, color:T.text, flex:1}}>{a}</span><div style={{width:100, height:8, borderRadius:4, background:T.border}}><div style={{height:"100%", borderRadius:4, background:T.accent, width:`${(c/maxAct)*100}%`}}/></div><span style={{fontSize:12, color:T.textSub, minWidth:28, textAlign:"right"}}>{c}íšŒ</span></div>))}
            </div>
          )}
        </div>
      );
    }

    function MyPage({diaries, streak}) {
      const {user, logout} = useAuth();
      const photoCount = diaries.filter(d=>d.photo_url).length;
      const [loggingOut, setLoggingOut] = useState(false);
      const handleLogout = async () => { setLoggingOut(true); await logout(); };
      return (
        <div style={{padding:"20px 16px", paddingBottom:20}}>
          <div style={{fontSize:20, fontWeight:800, color:T.text, marginBottom:16}}>ë§ˆì´í˜ì´ì§€</div>
          <div style={{background:T.card, borderRadius:16, padding:24, marginBottom:12, boxShadow:T.shadow}}>
            <div style={{display:"flex", alignItems:"center", gap:14, marginBottom:20}}>
              <div style={{width:56, height:56, borderRadius:"50%", background:T.accentBg, display:"flex", alignItems:"center", justifyContent:"center", fontSize:24, fontWeight:700, color:T.accent, flexShrink:0}}>{user?.name?.[0]||"?"}</div>
              <div><div style={{fontSize:17, fontWeight:700, color:T.text}}>{user?.name}</div><div style={{fontSize:13, color:T.textSub}}>{user?.email}</div></div>
            </div>
            <div style={{display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10}}>
              <div style={{textAlign:"center", padding:14, background:T.bg, borderRadius:12}}><div style={{fontSize:20, fontWeight:800, color:T.accent}}>{diaries.length}</div><div style={{fontSize:11, color:T.textSub, marginTop:2}}>ê¸°ë¡í•œ í•˜ë£¨</div></div>
              <div style={{textAlign:"center", padding:14, background:T.bg, borderRadius:12}}><div style={{fontSize:20, fontWeight:800, color:T.accent}}>{streak}</div><div style={{fontSize:11, color:T.textSub, marginTop:2}}>ì—°ì† ê¸°ë¡</div></div>
              <div style={{textAlign:"center", padding:14, background:T.bg, borderRadius:12}}><div style={{fontSize:20, fontWeight:800, color:T.accent}}>{photoCount}</div><div style={{fontSize:11, color:T.textSub, marginTop:2}}>ì‚¬ì§„ ê¸°ë¡</div></div>
            </div>
          </div>
          <button onClick={handleLogout} disabled={loggingOut} style={{width:"100%", padding:15, borderRadius:12, border:`1px solid ${T.danger}`, background:"transparent", color:T.danger, fontSize:15, fontWeight:600, cursor:"pointer", minHeight:52, opacity:loggingOut?0.7:1}}>{loggingOut?"ë¡œê·¸ì•„ì›ƒ ì¤‘...":"ë¡œê·¸ì•„ì›ƒ"}</button>
        </div>
      );
    }

    function MainApp() {
      const {user} = useAuth();
      const [diaries, setDiaries] = useState([]);
      const [dbLoading, setDbLoading] = useState(true);
      const [mainTab, setMainTab] = useState("diary");
      const [selected, setSelected] = useState(null);
      const [writing, setWriting] = useState(false);
      const [showAI, setShowAI] = useState(false);
      const [showFilter, setShowFilter] = useState(false);
      const [sd, setSd] = useState(""); const [ed, setEd] = useState("");
      const [savedToast, setSavedToast] = useState(false);
      const [showEditConfirm, setShowEditConfirm] = useState(false);
      const [aiDiary, setAiDiary] = useState(null);
      const [showFloatingBtn, setShowFloatingBtn] = useState(false);
      const [searchQuery, setSearchQuery] = useState("");
      const [showSearch, setShowSearch] = useState(false);
      const recordBtnRef = useRef(null);
      const scrollRef = useRef(null);

      // ìŠ¤í¬ë¡¤ ì‹œ ê¸°ë¡ ë²„íŠ¼ì´ í™”ë©´ ë°–ì´ë©´ í”Œë¡œíŒ… ë²„íŠ¼ í‘œì‹œ
      useEffect(() => {
        const el = scrollRef.current;
        if (!el) return;
        const onScroll = () => {
          if (recordBtnRef.current) {
            const rect = recordBtnRef.current.getBoundingClientRect();
            setShowFloatingBtn(rect.bottom < 0);
          }
        };
        el.addEventListener("scroll", onScroll, {passive:true});
        return () => el.removeEventListener("scroll", onScroll);
      }, [mainTab]);

      // AI ë¶„ì„ ê²°ê³¼ ì €ì¥ í›„ ë¡œì»¬ state ì—…ë°ì´íŠ¸ (ì¬ë¡œë“œ ì—†ì´)
      const handleAnalysisSaved = useCallback((diaryId, text) => {
        setDiaries(prev => prev.map(d => d.id === diaryId ? { ...d, ai_analysis: text } : d));
      }, []);

      const loadDiaries = useCallback(async () => {
        setDbLoading(true);
        const { data, error } = await sb.from('diary_entries').select('*').eq('user_id', user.id).order('date', { ascending: false });
        if (data) setDiaries(data);
        if (error) console.error('ì¼ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
        setDbLoading(false);
      }, [user]);

      useEffect(() => { if (user) loadDiaries(); }, [user]);

      const todayWritten = diaries.some(d=>d.date===today());
      const streak = (() => {
        let s=0; const d=new Date(); const start=todayWritten?0:1;
        for(let i=start;i<365;i++){const ds=new Date(d); ds.setDate(ds.getDate()-i); const key=ds.toISOString().slice(0,10); if(diaries.some(x=>x.date===key)) s++; else break;}
        return s;
      })();
      const filtered = diaries.filter(d=>{
        if(sd&&d.date<sd) return false; if(ed&&d.date>ed) return false;
        if(searchQuery.trim()) {
          const q = searchQuery.trim().toLowerCase();
          const words = q.split(/\s+/);
          const haystack = [
            d.title, d.content,
            ...(d.emotions||[]).map(e=>EMOTIONS[e.key]?.label||""),
            ...(d.activities||[]),
            ...(d.places||[]).map(p=>p.name),
          ].join(" ").toLowerCase();
          if (!words.every(w => haystack.includes(w))) return false;
        }
        return true;
      });

      const handleSaveDiary = async (data) => {
        const existing = diaries.find(d=>d.date===today());
        if (existing) {
          const { error } = await sb.from('diary_entries').update(data).eq('id', existing.id);
          if (!error) setDiaries(diaries.map(d=>d.date===today()?{...d,...data}:d));
          else { console.error(error); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); return; }
        } else {
          const { data: newEntry, error } = await sb.from('diary_entries').insert({ ...data, user_id: user.id }).select().single();
          if (newEntry) setDiaries([newEntry, ...diaries]);
          else { console.error(error); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); return; }
        }
        setWriting(false);
        setSavedToast(true); setTimeout(()=>setSavedToast(false), 2200);
      };

      const tabs = [{id:"diary",label:"ì¼ê¸°",icon:"ğŸ“"},{id:"community",label:"ì—°ëŒ€",icon:"ğŸ”—"},{id:"stats",label:"ë‚˜ì˜ ê²°",icon:"âœ¨"},{id:"mypage",label:"ë§ˆì´",icon:"ğŸ‘¤"}];

      if (writing) return (<DiaryWritePage onSave={handleSaveDiary} onCancel={()=>setWriting(false)} editData={todayWritten?diaries.find(d=>d.date===today()):null}/>);
      if (selected) return <DiaryDetail diary={selected} onBack={()=>setSelected(null)}/>;

      return (
        <div style={{position:"fixed", inset:0, display:"flex", flexDirection:"column", background:T.bg, fontFamily:"'Noto Sans KR',sans-serif"}}>
          <div style={{ background:T.card, borderBottom:`1px solid ${T.border}`, padding:"0 20px", paddingTop:`calc(env(safe-area-inset-top,0px) + 10px)`, paddingBottom:10, display:"flex", alignItems:"center", justifyContent:"space-between", flexShrink:0 }}>
            <span style={{fontSize:17, fontWeight:800, color:T.accent, letterSpacing:3}}>GYEOL</span>
            <div style={{display:"flex", gap:8, alignItems:"center"}}>
              {mainTab==="diary" && (<>
                <button onClick={()=>setShowSearch(s=>!s)} style={{background:showSearch?T.accentBg:T.bg, border:`1px solid ${showSearch?T.accent:T.border}`, borderRadius:10, padding:"8px 12px", fontSize:13, color:showSearch?T.accent:T.text, cursor:"pointer", minHeight:36}}>ğŸ” ê²€ìƒ‰</button>
                <button onClick={()=>setShowFilter(true)} style={{background:T.bg, border:`1px solid ${T.border}`, borderRadius:10, padding:"8px 12px", fontSize:13, color:T.text, cursor:"pointer", minHeight:36}}>ğŸ“… í•„í„°</button>
                <button onClick={()=>setShowAI(true)} style={{background:T.bg, border:`1px solid ${T.border}`, borderRadius:10, padding:"8px 12px", fontSize:13, color:T.text, cursor:"pointer", minHeight:36}}>âœ¨ ê²° ë¶„ì„</button>
              </>)}
              {streak>0 && (<div style={{background:T.accent, borderRadius:10, padding:"6px 10px", fontSize:12, color:"#fff", fontWeight:700}}>ğŸ”¥ {streak}ì¼</div>)}
            </div>
          </div>

          {/* ê²€ìƒ‰ë°” */}
          {showSearch && mainTab==="diary" && (
            <div style={{background:T.card, borderBottom:`1px solid ${T.border}`, padding:"8px 16px", flexShrink:0, animation:"fadeIn 0.2s ease"}}>
              <div style={{display:"flex", alignItems:"center", background:T.input, borderRadius:12, border:`1.5px solid ${T.border}`, padding:"0 14px"}}>
                <span style={{fontSize:14, color:T.textSub, marginRight:8}}>ğŸ”</span>
                <input value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}
                  placeholder="ì œëª©, ë‚´ìš©, ê°ì •, í™œë™, ì¥ì†Œë¡œ ê²€ìƒ‰..."
                  autoFocus
                  style={{flex:1, border:"none", background:"transparent", outline:"none", fontSize:14, color:T.text, padding:"11px 0", fontFamily:"inherit"}}/>
                {searchQuery && (
                  <button onClick={()=>setSearchQuery("")}
                    style={{background:"none", border:"none", fontSize:14, color:T.textSub, cursor:"pointer", padding:4}}>âœ•</button>
                )}
              </div>
            </div>
          )}

          <div ref={scrollRef} style={{flex:1, overflowY:"auto", WebkitOverflowScrolling:"touch"}}>
            {mainTab==="diary" && (
              <div style={{padding:"16px 16px 12px"}}>
                {dbLoading ? (<div style={{textAlign:"center", padding:40, color:T.textSub}}><div style={{fontSize:14}}>ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>) : (<>
                  <WeeklyAISummary diaries={diaries}/>
                  {streak>0 && (<div style={{background:T.gradient, borderRadius:14, padding:"14px 18px", marginBottom:14, display:"flex", alignItems:"center", justifyContent:"space-between", color:"#fff"}}><div><div style={{fontSize:14, fontWeight:700}}>ğŸ”¥ {streak}ì¼ì§¸ ë‚˜ë¥¼ ë“¤ì—¬ë‹¤ë³´ëŠ” ì¤‘</div><div style={{fontSize:11, opacity:0.85, marginTop:1}}>ë§¤ì¼ ìŒ“ì´ëŠ” ê¸°ë¡ì´ ê²°ì„ ë§Œë“¤ì–´ìš”</div></div><div style={{fontSize:28, fontWeight:800}}>{streak}</div></div>)}
                  <button ref={recordBtnRef} onClick={()=>{if(todayWritten) setShowEditConfirm(true); else setWriting(true);}}
                    style={{width:"100%", padding:16, borderRadius:14, border:"none", background:todayWritten?T.border:T.gradient, color:todayWritten?T.textSub:"#fff", fontSize:15, fontWeight:700, cursor:"pointer", marginBottom:16, minHeight:52, boxShadow:todayWritten?"none":`0 4px 16px ${T.accent}44`, display:"flex", alignItems:"center", justifyContent:"center", gap:6}}>
                    <span style={{fontSize:18}}>âœï¸</span>{todayWritten?"ì˜¤ëŠ˜ ì¼ê¸° ìˆ˜ì •í•˜ê¸°":"ì˜¤ëŠ˜ í•˜ë£¨ ê¸°ë¡í•˜ê¸°"}
                  </button>
                  <div style={{display:"flex", flexDirection:"column", gap:10}}>
                    {filtered.length===0 && (<div style={{textAlign:"center", padding:40, color:T.textSub}}><div style={{fontSize:40, marginBottom:10}}>{searchQuery?"ğŸ”":"âœï¸"}</div><div style={{fontSize:14, lineHeight:1.7}}>{searchQuery?`"${searchQuery}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”.`:"ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.\nì˜¤ëŠ˜ì˜ í•˜ë£¨ë¥¼ ì†”ì§í•˜ê²Œ ì ì–´ë³´ì„¸ìš”."}</div></div>)}
                    {filtered.map(d=>{
                      return (
                        <div key={d.id} style={{background:T.card, borderRadius:16, padding:"16px 18px", boxShadow:T.shadow, border:"1px solid transparent"}}>
                          <div onClick={()=>setSelected(d)} style={{cursor:"pointer"}}>
                            <div style={{display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:6}}>
                              <div style={{display:"flex", alignItems:"center", gap:6}}><span style={{fontSize:12, color:T.textSub}}>{fmt(d.date)}</span>{isToday(d.date)&&<span style={{background:T.accent, color:"#fff", padding:"2px 8px", borderRadius:6, fontSize:10, fontWeight:700}}>TODAY</span>}</div>
                              {d.photo_url&&<span style={{fontSize:16, flexShrink:0}}>ğŸ“·</span>}
                            </div>
                            <div style={{fontSize:15, fontWeight:700, color:T.text, marginBottom:8, lineHeight:1.4}}>{d.title}</div>
                            <div style={{display:"flex", flexWrap:"wrap", gap:5, marginBottom:6}}>
                              {(d.emotions||[]).map(e=>EMOTIONS[e.key]?(<span key={e.key} style={{padding:"4px 10px", borderRadius:12, background:EMOTIONS[e.key].color+"22", fontSize:12, color:T.text, fontWeight:500}}>{EMOTIONS[e.key].emoji} {EMOTIONS[e.key].label}</span>):null)}
                            </div>
                            <div style={{display:"flex", flexWrap:"wrap", gap:6}}>
                              {(d.places||[]).map((p,i)=>(<span key={i} style={{fontSize:11, color:T.textSub}}>ğŸ“ {p.name}</span>))}
                            </div>
                          </div>
                          <div style={{marginTop:10, paddingTop:10, borderTop:`1px solid ${T.border}`}}>
                            <button onClick={e=>{e.stopPropagation(); setAiDiary(d);}}
                              style={{width:"100%", padding:"8px 0", border:`1px solid ${T.accentLight}`, borderRadius:10, background:T.accentBg, color:T.accent, fontSize:13, fontWeight:700, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:5, minHeight:36}}>
                              ğŸ¤– AI ë¶„ì„ ë³´ê¸°
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </>)}
              </div>
            )}
            {mainTab==="stats" && <StatsTab diaries={diaries}/>}
            {mainTab==="mypage" && <MyPage diaries={diaries} streak={streak}/>}
            {mainTab==="community" && (
              <div style={{textAlign:"center", padding:"80px 20px", color:T.textSub}}>
                <div style={{fontSize:48, marginBottom:16}}>ğŸ”—</div>
                <div style={{fontSize:17, fontWeight:700, color:T.text, marginBottom:8}}>ê²°ì´ ë§ëŠ” ì‚¬ëŒë“¤</div>
                <div style={{fontSize:14, lineHeight:1.8, color:T.textSub, maxWidth:280, margin:"0 auto"}}>ê¸°ë¡ì´ ìŒ“ì´ë©´, ë‹¹ì‹ ì˜ ê²°ê³¼ ê³µëª…í•˜ëŠ” ì‚¬ëŒë“¤ì„ ë§Œë‚  ìˆ˜ ìˆê²Œ ë  ê±°ì˜ˆìš”.</div>
                <div style={{marginTop:24, padding:"12px 24px", borderRadius:20, background:T.accentBg, display:"inline-block", fontSize:13, color:T.accent, fontWeight:600}}>ê³§ ì˜¤í”ˆ ì˜ˆì •</div>
              </div>
            )}
          </div>

          <div style={{background:T.card, borderTop:`1px solid ${T.border}`, display:"flex", paddingBottom:`env(safe-area-inset-bottom,0px)`, flexShrink:0}}>
            {tabs.map(t=>(
              <button key={t.id} onClick={()=>setMainTab(t.id)} style={{flex:1, display:"flex", flexDirection:"column", alignItems:"center", padding:"10px 0", border:"none", background:"none", cursor:"pointer", color:mainTab===t.id?T.accent:T.textSub, minHeight:56}}>
                <span style={{fontSize:22, marginBottom:2}}>{t.icon}</span>
                <span style={{fontSize:10, fontWeight:mainTab===t.id?700:500}}>{t.label}</span>
                {mainTab===t.id&&<div style={{width:4, height:4, borderRadius:"50%", background:T.accent, marginTop:3}}/>}
              </button>
            ))}
          </div>

          {showFilter && (
            <div style={{position:"fixed", inset:0, background:"rgba(74,55,40,0.5)", zIndex:200, display:"flex", flexDirection:"column", justifyContent:"flex-end"}} onClick={()=>setShowFilter(false)}>
              <div onClick={e=>e.stopPropagation()} style={{background:T.card, borderRadius:"20px 20px 0 0", padding:"24px 20px", paddingBottom:`calc(env(safe-area-inset-bottom,0px) + 24px)`}}>
                <div style={{width:36, height:4, borderRadius:2, background:T.border, margin:"0 auto 20px"}}/>
                <div style={{fontSize:16, fontWeight:700, color:T.text, marginBottom:16}}>ğŸ“… ë‚ ì§œ í•„í„°</div>
                <div style={{marginBottom:12}}><div style={{fontSize:12, color:T.textSub, fontWeight:600, marginBottom:6}}>ì‹œì‘ ë‚ ì§œ</div><input type="date" value={sd} onChange={e=>setSd(e.target.value)} style={{width:"100%", padding:"12px 14px", borderRadius:12, border:`1px solid ${T.border}`, fontSize:16, background:T.bg, color:T.text, boxSizing:"border-box", WebkitAppearance:"none"}}/></div>
                <div style={{marginBottom:20}}><div style={{fontSize:12, color:T.textSub, fontWeight:600, marginBottom:6}}>ë ë‚ ì§œ</div><input type="date" value={ed} onChange={e=>setEd(e.target.value)} style={{width:"100%", padding:"12px 14px", borderRadius:12, border:`1px solid ${T.border}`, fontSize:16, background:T.bg, color:T.text, boxSizing:"border-box", WebkitAppearance:"none"}}/></div>
                <div style={{display:"flex", gap:10}}>
                  <button onClick={()=>{setSd("");setEd("");setShowFilter(false);}} style={{flex:1, padding:15, borderRadius:12, border:`1px solid ${T.border}`, background:T.card, fontSize:15, fontWeight:600, color:T.textSub, cursor:"pointer", minHeight:50}}>ì´ˆê¸°í™”</button>
                  <button onClick={()=>setShowFilter(false)} style={{flex:1, padding:15, borderRadius:12, border:"none", background:T.accent, color:"#fff", fontSize:15, fontWeight:700, cursor:"pointer", minHeight:50}}>ì ìš©</button>
                </div>
              </div>
            </div>
          )}

          {showAI && <AIChatModal onClose={()=>setShowAI(false)} diaries={diaries}/>}
          {aiDiary && <DiaryAIModal diary={aiDiary} onClose={()=>setAiDiary(null)} onAnalysisSaved={handleAnalysisSaved}/>}

          {showEditConfirm && (
            <div style={{position:"fixed", inset:0, background:"rgba(74,55,40,0.5)", zIndex:200, display:"flex", flexDirection:"column", justifyContent:"flex-end"}} onClick={()=>setShowEditConfirm(false)}>
              <div onClick={e=>e.stopPropagation()} style={{background:T.card, borderRadius:"20px 20px 0 0", padding:"24px 20px", paddingBottom:`calc(env(safe-area-inset-bottom,0px) + 24px)`, textAlign:"center"}}>
                <div style={{width:36, height:4, borderRadius:2, background:T.border, margin:"0 auto 20px"}}/>
                <div style={{fontSize:36, marginBottom:10}}>âœï¸</div>
                <div style={{fontSize:16, fontWeight:700, color:T.text, marginBottom:6}}>ì˜¤ëŠ˜ ì¼ê¸°ë¥¼ ì´ë¯¸ ì‘ì„±í–ˆì–´ìš”</div>
                <div style={{fontSize:14, color:T.textSub, marginBottom:20, lineHeight:1.6}}>ìˆ˜ì •í•˜ì‹œê² ì–´ìš”?</div>
                <div style={{display:"flex", gap:10}}>
                  <button onClick={()=>setShowEditConfirm(false)} style={{flex:1, padding:15, borderRadius:12, border:`1px solid ${T.border}`, background:T.card, fontSize:15, fontWeight:600, color:T.textSub, cursor:"pointer", minHeight:50}}>ì·¨ì†Œ</button>
                  <button onClick={()=>{setShowEditConfirm(false);setWriting(true);}} style={{flex:1, padding:15, borderRadius:12, border:"none", background:T.accent, color:"#fff", fontSize:15, fontWeight:700, cursor:"pointer", minHeight:50}}>ìˆ˜ì •í•˜ê¸°</button>
                </div>
              </div>
            </div>
          )}

          {/* í”Œë¡œíŒ… ê¸°ë¡ ë²„íŠ¼ */}
          {showFloatingBtn && mainTab==="diary" && (
            <button onClick={()=>{if(todayWritten) setShowEditConfirm(true); else setWriting(true);}}
              style={{position:"fixed", top:`calc(env(safe-area-inset-top,0px) + 60px)`, left:"50%", transform:"translateX(-50%)", padding:"12px 28px", borderRadius:30, border:"none", background:todayWritten?"rgba(232,223,208,0.95)":T.accent, color:todayWritten?T.textSub:"#fff", fontSize:14, fontWeight:700, cursor:"pointer", zIndex:90, boxShadow:"0 4px 20px rgba(0,0,0,0.15)", display:"flex", alignItems:"center", gap:6, animation:"slideUp 0.25s ease", backdropFilter:"blur(10px)", WebkitBackdropFilter:"blur(10px)"}}>
              <span style={{fontSize:16}}>âœï¸</span>{todayWritten?"ì˜¤ëŠ˜ ì¼ê¸° ìˆ˜ì •í•˜ê¸°":"ì˜¤ëŠ˜ í•˜ë£¨ ê¸°ë¡í•˜ê¸°"}
            </button>
          )}

          {savedToast && (
            <div style={{position:"fixed", bottom:`calc(env(safe-area-inset-bottom,0px) + 72px)`, left:"50%", transform:"translateX(-50%)", background:T.accent, color:"#fff", padding:"13px 28px", borderRadius:14, fontSize:14, fontWeight:600, boxShadow:`0 8px 32px ${T.accent}66`, zIndex:2000, whiteSpace:"nowrap", animation:"slideUp 0.3s ease"}}>
              âœ¨ ì˜¤ëŠ˜ì˜ ê²°ì´ ì €ì¥ë˜ì—ˆì–´ìš”
            </div>
          )}
        </div>
      );
    }

    function AuthRouter() {
      const {user, loading} = useAuth();
      if (loading) return <LoadingScreen text="ë‚˜ì˜ ê²°ì„ ë°œê²¬í•˜ëŠ” ì¤‘..."/>;
      return user ? <MainApp/> : <LoginPage/>;
    }
    function App() { return <AuthProvider><AuthRouter/></AuthProvider>; }
    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>